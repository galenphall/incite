var z=Object.defineProperty;var tt=Object.getOwnPropertyDescriptor;var et=Object.getOwnPropertyNames;var it=Object.prototype.hasOwnProperty;var st=(s,i)=>{for(var t in i)z(s,t,{get:i[t],enumerable:!0})},rt=(s,i,t,e)=>{if(i&&typeof i=="object"||typeof i=="function")for(let r of et(i))!it.call(s,r)&&r!==t&&z(s,r,{get:()=>i[r],enumerable:!(e=tt(i,r))||e.enumerable});return s};var nt=s=>rt(z({},"__esModule",{value:!0}),s);var pt={};st(pt,{default:()=>W});module.exports=nt(pt);var x=require("obsidian");var J=require("obsidian");var _=class{async get(i){let t=await fetch(i,{method:"GET",headers:{Accept:"application/json"}});if(!t.ok)throw new Error(`HTTP ${t.status}: ${t.statusText}`);return t.json()}async post(i,t){let e=await fetch(i,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify(t)});if(!e.ok)throw new Error(`HTTP ${e.status}: ${e.statusText}`);return e.json()}},T=class{constructor(i,t){this.baseUrl=i,this.transport=t!=null?t:new _}setBaseUrl(i){this.baseUrl=i}async health(){return await this.transport.get(`${this.baseUrl}/health`)}async recommend(i,t,e,r){let n={query:i,k:t,author_boost:e};return r!==void 0&&(n.cursor_sentence_index=r),await this.transport.post(`${this.baseUrl}/recommend`,n)}};function K(s){let i=/(?:Dr|Mr|Mrs|Ms|Prof|Sr|Jr|etc|Fig|Figs|Eq|Eqs|al|vs|i\.e|e\.g|cf|no|vol|pp|ed|Rev|Jan|Feb|Mar|Apr|Jun|Jul|Aug|Sep|Oct|Nov|Dec)\.\s*/gi,t="\0";return s.replace(i,n=>n.replace(/\.\s*/,t)).split(/(?<=[.!?])\s+(?=[A-Z"])/).map(n=>n.replace(new RegExp(t,"g"),". ").trim()).filter(n=>n.length>0)}function P(s){return s.replace(/\[@[^\]]*\]/g,"").replace(/\[cite\]/gi,"").replace(/\\cite\{[^}]*\}/g,"").replace(/\s{2,}/g," ").trim()}function $(s,i,t){let e=s.split(`
`),r=0,n=0;for(let u=0;u<e.length;u++)if(r+=e[u].length+1,r>i){n=u;break}let a=50,l=Math.max(0,n-a),c=Math.min(e.length,n+a),o=e.slice(l,c).join(`
`),p=0;for(let u=0;u<l;u++)p+=e[u].length+1;let d=i-p,h=K(o);if(h.length===0)return{text:P(o),rawText:o,cursorSentenceIndex:0,totalSentences:0};let y=0,m=0;for(let u=0;u<h.length;u++){let I=o.indexOf(h[u],y);if(I===-1)continue;let Z=I+h[u].length;if(d>=I&&d<=Z){m=u;break}if(I>d){m=Math.max(0,u-1);break}y=Z,m=u}let S=Math.floor(t/2),R=Math.max(0,m-S),q=Math.min(h.length,m+S+1),f=h.slice(R,q),b=f.join(" ");return{text:P(b),rawText:b,cursorSentenceIndex:m-R,totalSentences:f.length}}var w=class{constructor(i,t){this.debounceTimer=null;this.settings=i,this.onTrigger=t}updateSettings(i){this.settings=i}checkLine(i){this.settings.citationPatterns.some(e=>{try{return new RegExp(e).test(i)}catch(r){return!1}})&&(this.debounceTimer&&clearTimeout(this.debounceTimer),this.debounceTimer=setTimeout(()=>{this.debounceTimer=null,this.onTrigger()},this.settings.debounceMs))}dispose(){this.debounceTimer&&(clearTimeout(this.debounceTimer),this.debounceTimer=null)}};function B(s,i){var n,a,l,c,o,p;let t=(n=s.authors)!=null&&n[0]&&(a=s.authors[0].split(",")[0].split(" ").pop())!=null?a:"",e={bibtex_key:(l=s.bibtex_key)!=null?l:s.paper_id,paper_id:s.paper_id,first_author:t,year:(o=(c=s.year)==null?void 0:c.toString())!=null?o:"",title:s.title,zotero_uri:(p=s.zotero_uri)!=null?p:""},r=i;for(let[d,h]of Object.entries(e))r=r.replace(new RegExp(`\\{${d}\\}`,"g"),h),r=r.replace(new RegExp(`\\$\\{${d}\\}`,"g"),h);return r}function Q(s){return/\\cite\{/.test(s)?"latex":/\[@/.test(s)?"pandoc":"individual"}function A(s,i,t="; "){if(s.length===0)return"";if(s.length===1)return B(s[0],i);switch(Q(i)){case"latex":return`\\cite{${s.map(n=>{var a;return(a=n.bibtex_key)!=null?a:n.paper_id}).join(",")}}`;case"pandoc":return`[@${s.map(n=>{var a;return(a=n.bibtex_key)!=null?a:n.paper_id}).join("; @")}]`;case"individual":return s.map(r=>B(r,i)).join(t)}}function X(s){var i,t;return{paper_id:s.paper_id,bibtex_key:(i=s.bibtex_key)!=null?i:s.paper_id,title:s.title,authors:(t=s.authors)!=null?t:[],year:s.year,doi:s.doi,journal:s.journal,abstract:s.abstract,insertedAt:Date.now()}}var v=class{constructor(i,t){this.citations=[];this.storage=i,this.docKey=t}async load(){this.citations=await this.storage.load(this.docKey)}async track(i){for(let t of i)this.isTracked(t.paper_id)||this.citations.push(X(t));await this.storage.save(this.docKey,this.citations)}async remove(i){this.citations=this.citations.filter(t=>t.paper_id!==i),await this.storage.save(this.docKey,this.citations)}getAll(){return[...this.citations].sort((i,t)=>i.insertedAt-t.insertedAt)}isTracked(i){return this.citations.some(t=>t.paper_id===i)}get count(){return this.citations.length}};var at={"\\":"\\textbackslash{}","{":"\\{","}":"\\}","&":"\\&","%":"\\%","#":"\\#",_:"\\_","~":"\\textasciitilde{}","^":"\\textasciicircum{}"};function E(s){var t;let i="";for(let e of s)i+=(t=at[e])!=null?t:e;return i}function ot(s){let i=s.bibtex_key||s.paper_id,t=[];return t.push(`  title = {${E(s.title)}}`),s.authors.length>0&&t.push(`  author = {${E(s.authors.join(" and "))}}`),s.year!=null&&t.push(`  year = {${s.year}}`),s.journal&&t.push(`  journal = {${E(s.journal)}}`),s.doi&&t.push(`  doi = {${s.doi}}`),s.abstract&&t.push(`  abstract = {${E(s.abstract)}}`),`@article{${i},
${t.join(`,
`)}
}`}function L(s){return s.map(ot).join(`

`)}function ct(s){let i=[];i.push("TY  - JOUR"),i.push(`TI  - ${s.title}`);for(let t of s.authors)i.push(`AU  - ${t}`);return s.year!=null&&i.push(`PY  - ${s.year}`),s.doi&&i.push(`DO  - ${s.doi}`),s.journal&&i.push(`JO  - ${s.journal}`),s.abstract&&i.push(`AB  - ${s.abstract}`),i.push("ER  - "),i.join(`
`)}function j(s){return s.map(ct).join(`

`)}function M(s){if(s.includes(","))return s.split(",")[0].trim();let i=s.trim().split(/\s+/);return i[i.length-1]}function lt(s){let i=[];if(s.authors.length>0)if(s.authors.length<=2)i.push(s.authors.map(M).join(" & "));else{let t=s.authors.map(M),e=t.slice(0,-1).join(", ");i.push(`${e}, & ${t[t.length-1]}`)}return i.push(s.year!=null?`(${s.year}).`:"(n.d.)."),i.push(`${s.title}.`),s.journal&&i.push(`${s.journal}.`),s.doi&&i.push(`https://doi.org/${s.doi}`),i.join(" ")}function D(s){return[...s].sort((t,e)=>{let r=t.authors.length>0?M(t.authors[0]):"",n=e.authors.length>0?M(e.authors[0]):"";return r.localeCompare(n)}).map(lt).join(`

`)}var G=class{async get(i){return(await(0,J.requestUrl)({url:i,method:"GET"})).json}async post(i,t){let e={url:i,method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)};return(await(0,J.requestUrl)(e)).json}},N=class extends T{constructor(i){super(i,new G)}};var U=class{constructor(i,t,e){this.eventRef=null;this.lastEditor=null;this.app=i,this.onTrigger=e,this.core=new w(t,()=>{this.lastEditor&&this.onTrigger(this.lastEditor)})}start(i){this.eventRef=this.app.workspace.on("editor-change",t=>{this.lastEditor=t;let e=t.getCursor(),r=t.getLine(e.line);this.core.checkLine(r)}),i.registerEvent(this.eventRef)}stop(){this.core.dispose(),this.eventRef=null,this.lastEditor=null}updateSettings(i){this.core.updateSettings(i)}};var Y="incite-tracked-citations",F=class{constructor(i){this.plugin=i}async load(i){var r,n;let t=await this.plugin.loadData();return(n=((r=t==null?void 0:t[Y])!=null?r:{})[i])!=null?n:[]}async save(i,t){var n,a;let e=(n=await this.plugin.loadData())!=null?n:{},r=(a=e[Y])!=null?a:{};r[i]=t,e[Y]=r,await this.plugin.saveData(e)}};var g=require("obsidian"),O=class extends g.PluginSettingTab{constructor(i,t){super(i,t),this.plugin=t}display(){let{containerEl:i}=this;i.empty(),i.createEl("h3",{text:"Server"}),new g.Setting(i).setName("API URL").setDesc("URL of the inCite server (run 'incite serve')").addText(t=>t.setPlaceholder("http://127.0.0.1:8230").setValue(this.plugin.settings.apiUrl).onChange(async e=>{this.plugin.settings.apiUrl=e,await this.plugin.saveSettings()})),new g.Setting(i).setName("Test connection").setDesc("Check if the inCite server is reachable").addButton(t=>t.setButtonText("Test").onClick(async()=>{try{let e=await this.plugin.client.health();e.ready?new g.Notice(`Connected! ${e.corpus_size} papers, mode: ${e.mode||"paper"}`):new g.Notice("Server is loading, try again in a moment.")}catch(e){new g.Notice("Could not connect. Is 'incite serve' running?")}})),i.createEl("h3",{text:"Retrieval"}),new g.Setting(i).setName("Number of results").setDesc("How many recommendations to show").addSlider(t=>t.setLimits(1,50,1).setValue(this.plugin.settings.k).setDynamicTooltip().onChange(async e=>{this.plugin.settings.k=e,await this.plugin.saveSettings()})),new g.Setting(i).setName("Author boost").setDesc("Boost papers whose authors appear in context (1.0 = no boost, 1.2 = 20% boost)").addText(t=>t.setPlaceholder("1.0").setValue(String(this.plugin.settings.authorBoost)).onChange(async e=>{let r=parseFloat(e);!isNaN(r)&&r>=0&&r<=5&&(this.plugin.settings.authorBoost=r,await this.plugin.saveSettings())})),new g.Setting(i).setName("Context sentences").setDesc("Total sentences to extract around cursor (split before/after)").addSlider(t=>t.setLimits(2,20,1).setValue(this.plugin.settings.contextSentences).setDynamicTooltip().onChange(async e=>{this.plugin.settings.contextSentences=e,await this.plugin.saveSettings()})),i.createEl("h3",{text:"Citation format"}),new g.Setting(i).setName("Insert format").setDesc("Placeholders: {first_author}, {year}, {paper_id}, {bibtex_key}, {title}").addText(t=>t.setPlaceholder("[({first_author}, {year})](zotero://.../{paper_id})").setValue(this.plugin.settings.insertFormat).onChange(async e=>{this.plugin.settings.insertFormat=e,await this.plugin.saveSettings()})),i.createEl("h3",{text:"Auto-detection"}),new g.Setting(i).setName("Enable auto-detection").setDesc("Automatically trigger recommendations when a citation marker is detected").addToggle(t=>t.setValue(this.plugin.settings.autoDetectEnabled).onChange(async e=>{this.plugin.settings.autoDetectEnabled=e,await this.plugin.saveSettings()})),new g.Setting(i).setName("Debounce delay (ms)").setDesc("Wait this long after typing before triggering (default: 500)").addText(t=>t.setPlaceholder("500").setValue(String(this.plugin.settings.debounceMs)).onChange(async e=>{let r=parseInt(e);!isNaN(r)&&r>=100&&r<=5e3&&(this.plugin.settings.debounceMs=r,await this.plugin.saveSettings())})),i.createEl("h3",{text:"Display"}),new g.Setting(i).setName("Show matched paragraphs").setDesc("Display paragraph evidence when the server runs in paragraph mode").addToggle(t=>t.setValue(this.plugin.settings.showParagraphs).onChange(async e=>{this.plugin.settings.showParagraphs=e,await this.plugin.saveSettings()}))}};var C=require("obsidian"),k="incite-sidebar",H=class extends C.ItemView{constructor(t,e,r,n,a){super(t);this.results=[];this.loading=!1;this.errorMessage=null;this.selectedRecs=new Map;this.trackedCitations=[];this.onRemoveCitation=null;this.onExportBibliography=null;this.bibExpanded=!1;this.settings=e,this.onInsert=r,this.onInsertMulti=n,this.isTracked=a}getViewType(){return k}getDisplayText(){return"inCite"}getIcon(){return"book-open"}async onOpen(){this.render()}async onClose(){}updateSettings(t){this.settings=t}setBibliography(t,e,r){this.trackedCitations=t,this.onRemoveCitation=e,this.onExportBibliography=r,this.render()}updateTrackedCitations(t){this.trackedCitations=t,this.render()}setLoading(){this.loading=!0,this.errorMessage=null,this.render()}setError(t){this.loading=!1,this.errorMessage=t,this.results=[],this.render()}setResults(t){this.loading=!1,this.errorMessage=null,this.results=t,this.selectedRecs.clear(),this.render()}render(){var r;let t=this.containerEl.children[1];if(t.empty(),t.createEl("div",{cls:"mayacite-header"},n=>{n.createEl("h4",{text:"inCite"})}),this.loading){t.createEl("div",{cls:"mayacite-loading"},n=>{n.createEl("span",{text:"Searching..."})});return}if(this.errorMessage){t.createEl("div",{cls:"mayacite-error"},n=>{n.createEl("span",{text:this.errorMessage})});return}if(this.results.length===0){t.createEl("div",{cls:"mayacite-empty"},n=>{n.createEl("span",{text:"No results yet. Place your cursor and press Cmd/Ctrl+Shift+C."})}),this.renderBibliography(t);return}this.renderSelectionBar(t);let e=t.createEl("div",{cls:"mayacite-results"});for(let n of this.results){let a=e.createEl("div",{cls:"mayacite-result"});if(a.createEl("div",{cls:"mayacite-result-rank"},o=>{var y;let p=o.createEl("input",{type:"checkbox",cls:"mayacite-select-checkbox"});p.checked=this.selectedRecs.has(n.paper_id),p.addEventListener("change",()=>{p.checked?this.selectedRecs.set(n.paper_id,n):this.selectedRecs.delete(n.paper_id),this.renderSelectionBarUpdate()}),o.createEl("span",{cls:"mayacite-rank-number",text:`${n.rank}.`});let d=(y=n.confidence)!=null?y:0,h=d>=.55?"mayacite-confidence-high":d>=.35?"mayacite-confidence-mid":"mayacite-confidence-low";o.createEl("span",{cls:`mayacite-confidence ${h}`,text:d.toFixed(2),attr:{title:`Confidence: ${d.toFixed(3)}`}})}),a.createEl("div",{cls:"mayacite-result-title",text:n.title}),n.authors||n.year){let o=[];if(n.authors&&n.authors.length>0){let p=n.authors.slice(0,3).join(", ");o.push(n.authors.length>3?`${p} et al.`:p)}n.year&&o.push(`(${n.year})`),a.createEl("div",{cls:"mayacite-result-meta",text:o.join(" ")})}if(this.settings.showParagraphs){if((r=n.matched_paragraphs)!=null&&r.length)n.matched_paragraphs.forEach((o,p)=>{let d=a.createEl("blockquote",{cls:p===0?"mayacite-paragraph":"mayacite-paragraph mayacite-paragraph-secondary"});o.score!=null&&d.createEl("span",{cls:"mayacite-evidence-score",text:`${(o.score*100).toFixed(0)}%`}),this.renderHighlightedText(o.text,d,350)});else if(n.matched_paragraph){let o=a.createEl("blockquote",{cls:"mayacite-paragraph"});this.renderHighlightedText(n.matched_paragraph,o,350)}}let l=a.createEl("div",{cls:"mayacite-result-actions"}),c=l.createEl("button",{cls:"mayacite-insert-btn",text:"Insert"});(0,C.setIcon)(c.createSpan({cls:"mayacite-insert-icon"}),"plus"),c.addEventListener("click",()=>{this.onInsert(n)}),this.isTracked(n.paper_id)&&l.createEl("span",{cls:"mayacite-cited-badge",text:"Cited",attr:{title:"Already cited in this document"}})}this.renderBibliography(t)}renderSelectionBar(t){let e=t.createEl("div",{cls:"mayacite-selection-bar",attr:{style:this.selectedRecs.size>0?"":"display:none"}});e.dataset.selectionBar="true",e.createEl("span",{cls:"mayacite-selection-count",text:`${this.selectedRecs.size} selected`}),e.createEl("button",{cls:"mayacite-insert-btn",text:"Insert Selected"}).addEventListener("click",()=>{let a=Array.from(this.selectedRecs.values());a.length>0&&(this.onInsertMulti(a),this.selectedRecs.clear(),this.render())}),e.createEl("button",{cls:"mayacite-clear-btn",text:"Clear"}).addEventListener("click",()=>{this.selectedRecs.clear(),this.render()})}renderSelectionBarUpdate(){let e=this.containerEl.children[1].querySelector("[data-selection-bar]");if(e)if(this.selectedRecs.size>0){e.style.display="";let r=e.querySelector(".mayacite-selection-count");r&&(r.textContent=`${this.selectedRecs.size} selected`)}else e.style.display="none"}renderBibliography(t){var l;if(this.trackedCitations.length===0&&!this.onExportBibliography)return;let e=t.createEl("div",{cls:"mayacite-bibliography"}),r=e.createEl("div",{cls:"mayacite-bib-header"}),n=r.createEl("span",{cls:"mayacite-bib-toggle"});if((0,C.setIcon)(n,this.bibExpanded?"chevron-down":"chevron-right"),r.createEl("span",{text:`Bibliography (${this.trackedCitations.length} citations)`}),r.addEventListener("click",()=>{this.bibExpanded=!this.bibExpanded,this.render()}),!this.bibExpanded)return;if(this.onExportBibliography&&this.trackedCitations.length>0){let c=e.createEl("div",{cls:"mayacite-bib-export"});for(let o of["BibTeX","RIS","Text"])c.createEl("button",{cls:"mayacite-export-btn",text:o}).addEventListener("click",()=>{this.onExportBibliography(o.toLowerCase())})}if(this.trackedCitations.length===0){e.createEl("div",{cls:"mayacite-bib-empty",text:"No citations tracked yet. Insert a citation to begin."});return}let a=e.createEl("div",{cls:"mayacite-bib-list"});for(let c of this.trackedCitations){let o=a.createEl("div",{cls:"mayacite-bib-item"}),p=c.authors.length>0&&(l=c.authors[0].split(/\s+/).pop())!=null?l:"",d=c.year?`${p} (${c.year})`:p;if(o.createEl("span",{cls:"mayacite-bib-label",text:d,attr:{title:c.title}}),o.createEl("span",{cls:"mayacite-bib-title",text:c.title}),this.onRemoveCitation){let h=o.createEl("button",{cls:"mayacite-bib-remove",attr:{title:"Remove from bibliography"}});(0,C.setIcon)(h,"x"),h.addEventListener("click",()=>{this.onRemoveCitation(c.paper_id)})}}}renderHighlightedText(t,e,r){let n=t.indexOf("**"),a=t.indexOf("**",n+2);if(n===-1||a===-1){let b=t.length>r?t.slice(0,r)+"...":t;e.appendText(b);return}let l=a+2,c=l-n,o=r-c,p=Math.floor(o*.3),d=o-p,h=Math.max(0,n-p),y=Math.min(t.length,l+d),m=t.slice(h,y),S=h>0,R=y<t.length;if(S){let f=m.indexOf(" ");f>0&&f<20&&(m=m.slice(f+1)),m="..."+m}R&&(m=m+"...");let q=m.split(/(\*\*.+?\*\*)/g);for(let f of q)if(f.startsWith("**")&&f.endsWith("**")){let b=f.slice(2,-2);e.createEl("strong",{text:b})}else f&&e.appendText(f)}};var V={apiUrl:"http://127.0.0.1:8230",k:10,authorBoost:1,contextSentences:6,citationPatterns:["\\[@[^\\]]*\\]","\\[cite\\]","\\\\cite\\{[^}]*\\}"],insertFormat:"[({first_author}, {year})]({zotero_uri})",autoDetectEnabled:!0,debounceMs:500,showParagraphs:!0};var W=class extends x.Plugin{constructor(){super(...arguments);this.settings=V;this.client=new N(V.apiUrl);this.watcher=null;this.lastEditor=null;this.tracker=null;this.citationStorage=null}async onload(){await this.loadSettings(),this.citationStorage=new F(this),this.registerView(k,t=>new H(t,this.settings,e=>this.insertCitation(e),e=>this.insertMultiCitation(e),e=>{var r,n;return(n=(r=this.tracker)==null?void 0:r.isTracked(e))!=null?n:!1})),this.addCommand({id:"recommend-at-cursor",name:"Get citation recommendations",editorCallback:t=>{this.recommendAtCursor(t)},hotkeys:[{modifiers:["Mod","Shift"],key:"c"}]}),this.addCommand({id:"open-sidebar",name:"Open recommendations panel",callback:()=>{this.activateSidebar()}}),this.app.workspace.on("active-leaf-change",()=>{this.initTrackerForActiveFile()}),await this.initTrackerForActiveFile(),this.settings.autoDetectEnabled&&this.startWatcher(),this.addSettingTab(new O(this.app,this))}onunload(){this.stopWatcher()}async loadSettings(){let t=await this.loadData();this.settings=Object.assign({},V,t),this.client.setBaseUrl(this.settings.apiUrl)}async saveSettings(){await this.saveData(this.settings),this.client.setBaseUrl(this.settings.apiUrl);let t=this.getSidebarView();t&&t.updateSettings(this.settings),this.settings.autoDetectEnabled?this.startWatcher():this.stopWatcher()}async initTrackerForActiveFile(){var r;if(!this.citationStorage)return;let t=this.app.workspace.getActiveFile(),e=(r=t==null?void 0:t.path)!=null?r:"__no_file__";this.tracker=new v(this.citationStorage,e),await this.tracker.load(),this.refreshBibliography()}refreshBibliography(){let t=this.getSidebarView();!t||!this.tracker||t.setBibliography(this.tracker.getAll(),e=>this.removeCitation(e),e=>this.exportBibliography(e))}async removeCitation(t){this.tracker&&(await this.tracker.remove(t),this.refreshBibliography())}exportBibliography(t){if(!this.tracker)return;let e=this.tracker.getAll();if(e.length===0){new x.Notice("No citations to export.");return}let r;switch(t){case"bibtex":r=L(e);break;case"ris":r=j(e);break;case"text":r=D(e);break;default:new x.Notice(`Unknown format: ${t}`);return}navigator.clipboard.writeText(r).then(()=>{new x.Notice(`${t.toUpperCase()} copied to clipboard (${e.length} citations).`)})}async activateSidebar(){let t=this.app.workspace.getLeavesOfType(k);if(t.length>0){this.app.workspace.revealLeaf(t[0]);return}let e=this.app.workspace.getRightLeaf(!1);e&&(await e.setViewState({type:k,active:!0}),this.app.workspace.revealLeaf(e))}getSidebarView(){let t=this.app.workspace.getLeavesOfType(k);return t.length>0?t[0].view:null}async recommendAtCursor(t){this.lastEditor=t,await this.activateSidebar();let e=this.getSidebarView(),r=t.getSelection(),n,a;if(r&&r.trim().length>0)n=r.trim();else{let l=t.getValue(),c=t.getCursor(),o=t.posToOffset(c),p=$(l,o,this.settings.contextSentences);n=p.text,a=p.cursorSentenceIndex}if(!n.trim()){e&&e.setError("No text around cursor to use as context.");return}e&&e.setLoading();try{let l=await this.client.recommend(n,this.settings.k,this.settings.authorBoost,a);e&&(e.setResults(l.recommendations),this.refreshBibliography())}catch(l){let c=l instanceof Error?l.message:"Failed to connect";e&&e.setError(`Could not reach inCite server at ${this.settings.apiUrl}. Is 'incite serve' running? (${c})`),new x.Notice("inCite: Server not reachable. Run 'incite serve'.")}}insertCitation(t){var o,p,d,h;let e=(d=(p=this.lastEditor)!=null?p:(o=this.app.workspace.activeEditor)==null?void 0:o.editor)!=null?d:null;if(!e){new x.Notice("No active editor to insert citation into.");return}let r="Unknown";if(t.authors&&t.authors.length>0){let y=t.authors[0].trim().split(/\s+/);r=y[y.length-1],t.authors.length>1&&(r+=" et al.")}let n=`zotero://select/items/0_${t.paper_id}`,a=this.settings.insertFormat.replace("{bibtex_key}",t.bibtex_key||t.paper_id).replace("{paper_id}",t.paper_id).replace("{first_author}",r).replace("{year}",String((h=t.year)!=null?h:"n.d.")).replace("{title}",t.title).replace("{zotero_uri}",t.zotero_uri||n),l=e.getCursor();e.replaceRange(a,l);let c=e.posToOffset(l)+a.length;e.setCursor(e.offsetToPos(c)),this.tracker&&this.tracker.track([t]).then(()=>this.refreshBibliography()),new x.Notice(`Inserted: ${a}`)}insertMultiCitation(t){var l,c,o;let e=(o=(c=this.lastEditor)!=null?c:(l=this.app.workspace.activeEditor)==null?void 0:l.editor)!=null?o:null;if(!e){new x.Notice("No active editor to insert citations into.");return}let r=A(t,this.settings.insertFormat),n=e.getCursor();e.replaceRange(r,n);let a=e.posToOffset(n)+r.length;e.setCursor(e.offsetToPos(a)),this.tracker&&this.tracker.track(t).then(()=>this.refreshBibliography()),new x.Notice(`Inserted ${t.length} citations.`)}startWatcher(){this.watcher||(this.watcher=new U(this.app,this.settings,t=>this.recommendAtCursor(t)),this.watcher.start(this))}stopWatcher(){this.watcher&&(this.watcher.stop(),this.watcher=null)}};
