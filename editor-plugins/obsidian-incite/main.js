var J=Object.defineProperty;var nt=Object.getOwnPropertyDescriptor;var st=Object.getOwnPropertyNames;var rt=Object.prototype.hasOwnProperty;var at=(n,i)=>{for(var t in i)J(n,t,{get:i[t],enumerable:!0})},ot=(n,i,t,e)=>{if(i&&typeof i=="object"||typeof i=="function")for(let s of st(i))!rt.call(n,s)&&s!==t&&J(n,s,{get:()=>i[s],enumerable:!(e=nt(i,s))||e.enumerable});return n};var ct=n=>ot(J({},"__esModule",{value:!0}),n);var gt={};at(gt,{default:()=>G});module.exports=ct(gt);var y=require("obsidian");var Z=require("obsidian");var I={apiMode:"cloud",cloudUrl:"https://inciteref.com",localUrl:"http://127.0.0.1:8230",apiToken:"",k:10,authorBoost:1,contextSentences:6,citationPatterns:["\\[@[^\\]]*\\]","\\[cite\\]","\\\\cite\\{[^}]*\\}"],insertFormat:"({first_author}, {year})",autoDetectEnabled:!1,debounceMs:500,showParagraphs:!0};function P(n){return n.apiMode==="cloud"?n.cloudUrl:n.localUrl}var M=class{async get(i,t){let e=await fetch(i,{method:"GET",headers:{Accept:"application/json",...t}});if(!e.ok)throw new Error(`HTTP ${e.status}: ${e.statusText}`);return e.json()}async post(i,t,e){let s=await fetch(i,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json",...e},body:JSON.stringify(t)});if(!s.ok)throw new Error(`HTTP ${s.status}: ${s.statusText}`);return s.json()}},S=class{constructor(i,t){typeof i=="string"?this.config={apiMode:"local",cloudUrl:"https://inciteref.com",localUrl:i,apiToken:""}:this.config={...i},this.transport=t!=null?t:new M}updateConfig(i){Object.assign(this.config,i)}setBaseUrl(i){this.config.localUrl=i}getBaseUrl(){return this.config.apiMode==="cloud"?this.config.cloudUrl:this.config.localUrl}getAuthHeaders(){return this.config.apiMode==="cloud"&&this.config.apiToken?{Authorization:`Bearer ${this.config.apiToken}`}:{}}getEndpoint(i){if(this.config.apiMode==="cloud")switch(i){case"/health":return"/api/v1/health";case"/recommend":return"/api/v1/recommend";default:return i}return i}async authGet(i){let t=`${this.getBaseUrl()}${this.getEndpoint(i)}`;return this.transport.get(t,this.getAuthHeaders())}async authPost(i,t){let e=`${this.getBaseUrl()}${this.getEndpoint(i)}`;return this.transport.post(e,t,this.getAuthHeaders())}async health(){let t=await this.authGet("/health");return this.config.apiMode==="cloud"&&t.ready===void 0?{...t,ready:t.status==="ready"}:t}async recommend(i,t,e,s){let r={query:i,k:t,author_boost:e};return s!==void 0&&(r.cursor_sentence_index=s),await this.authPost("/recommend",r)}async savePapers(i){return await this.authPost("/api/v1/library/papers",i)}async checkLibrary(i){return(await this.authPost("/api/v1/library/check",{papers:i})).results}async getCollections(){return(await this.authGet("/api/v1/library/collections")).collections}async searchTags(i){let t=encodeURIComponent(i);return(await this.authGet(`/api/v1/library/tags/search?q=${t}`)).tags}};function X(n){let i=/(?:Dr|Mr|Mrs|Ms|Prof|Sr|Jr|etc|Fig|Figs|Eq|Eqs|al|vs|i\.e|e\.g|cf|no|vol|pp|ed|Rev|Jan|Feb|Mar|Apr|Jun|Jul|Aug|Sep|Oct|Nov|Dec)\.\s*/gi,t="\0";return n.replace(i,r=>r.replace(/\.\s*/,t)).split(/(?<=[.!?])\s+(?=[A-Z"])/).map(r=>r.replace(new RegExp(t,"g"),". ").trim()).filter(r=>r.length>0)}function A(n){return n.replace(/\[@[^\]]*\]/g,"").replace(/\[cite\]/gi,"").replace(/\\cite\{[^}]*\}/g,"").replace(/\s{2,}/g," ").trim()}function L(n,i,t){let e=n.split(`
`),s=0,r=0;for(let m=0;m<e.length;m++)if(s+=e[m].length+1,s>i){r=m;break}let o=50,l=Math.max(0,r-o),c=Math.min(e.length,r+o),a=e.slice(l,c).join(`
`),p=0;for(let m=0;m<l;m++)p+=e[m].length+1;let d=i-p,u=X(a);if(u.length===0)return{text:A(a),rawText:a,cursorSentenceIndex:0,totalSentences:0};let f=0,h=0;for(let m=0;m<u.length;m++){let _=a.indexOf(u[m],f);if(_===-1)continue;let et=_+u[m].length;if(d>=_&&d<=et){h=m;break}if(_>d){h=Math.max(0,m-1);break}f=et,h=m}let R=Math.floor(t/2),$=Math.max(0,h-R),K=Math.min(u.length,h+R+1),b=u.slice($,K),x=b.join(" ");return{text:A(x),rawText:x,cursorSentenceIndex:h-$,totalSentences:b.length}}var E=class{constructor(i,t){this.debounceTimer=null;this.settings=i,this.onTrigger=t}updateSettings(i){this.settings=i}checkLine(i){this.settings.citationPatterns.some(e=>{try{return new RegExp(e).test(i)}catch(s){return!1}})&&(this.debounceTimer&&clearTimeout(this.debounceTimer),this.debounceTimer=setTimeout(()=>{this.debounceTimer=null,this.onTrigger()},this.settings.debounceMs))}dispose(){this.debounceTimer&&(clearTimeout(this.debounceTimer),this.debounceTimer=null)}};function B(n,i){var o,l,c,a,p,d,u;let t=(o=n.authors)!=null&&o[0]&&(l=n.authors[0].split(",")[0].split(" ").pop())!=null?l:"",e=t&&n.year?`${t}${n.year}`:t||((c=n.title)==null?void 0:c.split(/\s+/).slice(0,3).join(""))||n.paper_id,s={bibtex_key:(a=n.bibtex_key)!=null?a:e,paper_id:n.paper_id,first_author:t,year:(d=(p=n.year)==null?void 0:p.toString())!=null?d:"",title:n.title,zotero_uri:(u=n.zotero_uri)!=null?u:""},r=i;for(let[f,h]of Object.entries(s))r=r.replace(new RegExp(`\\{${f}\\}`,"g"),h),r=r.replace(new RegExp(`\\$\\{${f}\\}`,"g"),h);return r}function it(n){return/\\cite\{/.test(n)?"latex":/\[@/.test(n)?"pandoc":"individual"}function U(n,i,t="; "){if(n.length===0)return"";if(n.length===1)return B(n[0],i);switch(it(i)){case"latex":return`\\cite{${n.map(r=>{var o;return(o=r.bibtex_key)!=null?o:r.paper_id}).join(",")}}`;case"pandoc":return`[@${n.map(r=>{var o;return(o=r.bibtex_key)!=null?o:r.paper_id}).join("; @")}]`;case"individual":{let s=n.map(c=>B(c,i)),r=s[0],l=[["(",")"],["[","]"]].find(([c,a])=>r.startsWith(c)&&r.endsWith(a));if(l){let[c,a]=l,p=s.map(d=>d.slice(1,-1));return`${c}${p.join(t)}${a}`}return s.join(t)}}}function Y(n){var i,t;return{paper_id:n.paper_id,bibtex_key:(i=n.bibtex_key)!=null?i:n.paper_id,title:n.title,authors:(t=n.authors)!=null?t:[],year:n.year,doi:n.doi,journal:n.journal,abstract:n.abstract,insertedAt:Date.now()}}var C=class{constructor(i,t){this.citations=[];this.storage=i,this.docKey=t}async load(){this.citations=await this.storage.load(this.docKey)}async track(i){for(let t of i)this.isTracked(t.paper_id)||this.citations.push(Y(t));await this.storage.save(this.docKey,this.citations)}async remove(i){this.citations=this.citations.filter(t=>t.paper_id!==i),await this.storage.save(this.docKey,this.citations)}getAll(){return[...this.citations].sort((i,t)=>i.insertedAt-t.insertedAt)}isTracked(i){return this.citations.some(t=>t.paper_id===i)}get count(){return this.citations.length}};var lt={"\\":"\\textbackslash{}","{":"\\{","}":"\\}","&":"\\&","%":"\\%","#":"\\#",_:"\\_","~":"\\textasciitilde{}","^":"\\textasciicircum{}"};function w(n){var t;let i="";for(let e of n)i+=(t=lt[e])!=null?t:e;return i}function pt(n){let i=n.bibtex_key||n.paper_id,t=[];return t.push(`  title = {${w(n.title)}}`),n.authors.length>0&&t.push(`  author = {${w(n.authors.join(" and "))}}`),n.year!=null&&t.push(`  year = {${n.year}}`),n.journal&&t.push(`  journal = {${w(n.journal)}}`),n.doi&&t.push(`  doi = {${n.doi}}`),n.abstract&&t.push(`  abstract = {${w(n.abstract)}}`),`@article{${i},
${t.join(`,
`)}
}`}function D(n){return n.map(pt).join(`

`)}function dt(n){let i=[];i.push("TY  - JOUR"),i.push(`TI  - ${n.title}`);for(let t of n.authors)i.push(`AU  - ${t}`);return n.year!=null&&i.push(`PY  - ${n.year}`),n.doi&&i.push(`DO  - ${n.doi}`),n.journal&&i.push(`JO  - ${n.journal}`),n.abstract&&i.push(`AB  - ${n.abstract}`),i.push("ER  - "),i.join(`
`)}function j(n){return n.map(dt).join(`

`)}function H(n){if(n.includes(","))return n.split(",")[0].trim();let i=n.trim().split(/\s+/);return i[i.length-1]}function ht(n){let i=[];if(n.authors.length>0)if(n.authors.length<=2)i.push(n.authors.map(H).join(" & "));else{let t=n.authors.map(H),e=t.slice(0,-1).join(", ");i.push(`${e}, & ${t[t.length-1]}`)}return i.push(n.year!=null?`(${n.year}).`:"(n.d.)."),i.push(`${n.title}.`),n.journal&&i.push(`${n.journal}.`),n.doi&&i.push(`https://doi.org/${n.doi}`),i.join(" ")}function N(n){return[...n].sort((t,e)=>{let s=t.authors.length>0?H(t.authors[0]):"",r=e.authors.length>0?H(e.authors[0]):"";return s.localeCompare(r)}).map(ht).join(`

`)}function F(n){return n>=.55?"high":n>=.35?"mid":"low"}var Q=class{async get(i,t){let e={url:i,method:"GET",headers:t?{...t}:void 0};return(await(0,Z.requestUrl)(e)).json}async post(i,t,e){let s={url:i,method:"POST",headers:{"Content-Type":"application/json",...e},body:JSON.stringify(t)};return(await(0,Z.requestUrl)(s)).json}},O=class extends S{constructor(i){super(i,new Q)}};var V=class{constructor(i,t,e){this.eventRef=null;this.lastEditor=null;this.app=i,this.onTrigger=e,this.core=new E(t,()=>{this.lastEditor&&this.onTrigger(this.lastEditor)})}start(i){this.eventRef=this.app.workspace.on("editor-change",t=>{this.lastEditor=t;let e=t.getCursor(),s=t.getLine(e.line);this.core.checkLine(s)}),i.registerEvent(this.eventRef)}stop(){this.core.dispose(),this.eventRef=null,this.lastEditor=null}updateSettings(i){this.core.updateSettings(i)}};var tt="incite-tracked-citations",q=class{constructor(i){this.plugin=i}async load(i){var s,r;let t=await this.plugin.loadData();return(r=((s=t==null?void 0:t[tt])!=null?s:{})[i])!=null?r:[]}async save(i,t){var r,o;let e=(r=await this.plugin.loadData())!=null?r:{},s=(o=e[tt])!=null?o:{};s[i]=t,e[tt]=s,await this.plugin.saveData(e)}};var g=require("obsidian"),W=class extends g.PluginSettingTab{constructor(i,t){super(i,t),this.plugin=t}display(){let{containerEl:i}=this;i.empty(),i.createEl("h3",{text:"Server"}),new g.Setting(i).setName("API mode").setDesc("Connect to the inCite cloud service or a local server").addDropdown(t=>t.addOption("cloud","Cloud (inciteref.com)").addOption("local","Local (incite serve)").setValue(this.plugin.settings.apiMode).onChange(async e=>{this.plugin.settings.apiMode=e,await this.plugin.saveSettings(),this.display()})),this.plugin.settings.apiMode==="cloud"?(new g.Setting(i).setName("API token").setDesc("Your inCite API token (from inciteref.com account settings)").addText(t=>t.setPlaceholder("Enter your API token").setValue(this.plugin.settings.apiToken).onChange(async e=>{this.plugin.settings.apiToken=e,await this.plugin.saveSettings()})),new g.Setting(i).setName("Cloud URL").setDesc("inCite cloud server URL").addText(t=>t.setPlaceholder("https://inciteref.com").setValue(this.plugin.settings.cloudUrl).onChange(async e=>{this.plugin.settings.cloudUrl=e,await this.plugin.saveSettings()}))):new g.Setting(i).setName("Local URL").setDesc("URL of the local inCite server (run 'incite serve')").addText(t=>t.setPlaceholder("http://127.0.0.1:8230").setValue(this.plugin.settings.localUrl).onChange(async e=>{this.plugin.settings.localUrl=e,await this.plugin.saveSettings()})),new g.Setting(i).setName("Test connection").setDesc("Check if the inCite server is reachable").addButton(t=>t.setButtonText("Test").onClick(async()=>{try{let e=await this.plugin.client.health();e.ready?new g.Notice(`Connected! ${e.corpus_size} papers, mode: ${e.mode||"paper"}`):new g.Notice("Server is loading, try again in a moment.")}catch(e){this.plugin.settings.apiMode==="cloud"?new g.Notice("Could not connect. Check your API token and server URL."):new g.Notice("Could not connect. Is 'incite serve' running?")}})),i.createEl("h3",{text:"Retrieval"}),new g.Setting(i).setName("Number of results").setDesc("How many recommendations to show").addSlider(t=>t.setLimits(1,50,1).setValue(this.plugin.settings.k).setDynamicTooltip().onChange(async e=>{this.plugin.settings.k=e,await this.plugin.saveSettings()})),new g.Setting(i).setName("Author boost").setDesc("Boost papers whose authors appear in context (1.0 = no boost, 1.2 = 20% boost)").addText(t=>t.setPlaceholder("1.0").setValue(String(this.plugin.settings.authorBoost)).onChange(async e=>{let s=parseFloat(e);!isNaN(s)&&s>=0&&s<=5&&(this.plugin.settings.authorBoost=s,await this.plugin.saveSettings())})),new g.Setting(i).setName("Context sentences").setDesc("Total sentences to extract around cursor (split before/after)").addSlider(t=>t.setLimits(2,20,1).setValue(this.plugin.settings.contextSentences).setDynamicTooltip().onChange(async e=>{this.plugin.settings.contextSentences=e,await this.plugin.saveSettings()})),i.createEl("h3",{text:"Citation format"}),new g.Setting(i).setName("Insert format").setDesc("Placeholders: {first_author}, {year}, {paper_id}, {bibtex_key}, {title}").addText(t=>t.setPlaceholder("[({first_author}, {year})](zotero://.../{paper_id})").setValue(this.plugin.settings.insertFormat).onChange(async e=>{this.plugin.settings.insertFormat=e,await this.plugin.saveSettings()})),i.createEl("h3",{text:"Auto-detection"}),new g.Setting(i).setName("Enable auto-detection").setDesc("Automatically trigger recommendations when a citation marker is detected").addToggle(t=>t.setValue(this.plugin.settings.autoDetectEnabled).onChange(async e=>{this.plugin.settings.autoDetectEnabled=e,await this.plugin.saveSettings()})),new g.Setting(i).setName("Debounce delay (ms)").setDesc("Wait this long after typing before triggering (default: 500)").addText(t=>t.setPlaceholder("500").setValue(String(this.plugin.settings.debounceMs)).onChange(async e=>{let s=parseInt(e);!isNaN(s)&&s>=100&&s<=5e3&&(this.plugin.settings.debounceMs=s,await this.plugin.saveSettings())})),i.createEl("h3",{text:"Display"}),new g.Setting(i).setName("Show matched paragraphs").setDesc("Display paragraph evidence when the server runs in paragraph mode").addToggle(t=>t.setValue(this.plugin.settings.showParagraphs).onChange(async e=>{this.plugin.settings.showParagraphs=e,await this.plugin.saveSettings()}))}};var T=require("obsidian");var v={...I,apiMode:"local",insertFormat:"[({first_author}, {year})]({zotero_uri})",autoDetectEnabled:!0,debounceMs:500};var k="incite-sidebar",z=class extends T.ItemView{constructor(t,e,s,r,o){super(t);this.results=[];this.loading=!1;this.errorMessage=null;this.selectedRecs=new Map;this.trackedCitations=[];this.onRemoveCitation=null;this.onExportBibliography=null;this.bibExpanded=!1;this.settings=e,this.onInsert=s,this.onInsertMulti=r,this.isTracked=o}getViewType(){return k}getDisplayText(){return"inCite"}getIcon(){return"book-open"}async onOpen(){this.render()}async onClose(){}updateSettings(t){this.settings=t}setBibliography(t,e,s){this.trackedCitations=t,this.onRemoveCitation=e,this.onExportBibliography=s,this.render()}updateTrackedCitations(t){this.trackedCitations=t,this.render()}setLoading(){this.loading=!0,this.errorMessage=null,this.render()}setError(t){this.loading=!1,this.errorMessage=t,this.results=[],this.render()}setResults(t){this.loading=!1,this.errorMessage=null,this.results=t,this.selectedRecs.clear(),this.render()}render(){var s;let t=this.containerEl.children[1];if(t.empty(),t.createEl("div",{cls:"mayacite-header"},r=>{r.createEl("h4",{text:"inCite"})}),this.loading){t.createEl("div",{cls:"mayacite-loading"},r=>{r.createEl("span",{text:"Searching..."})});return}if(this.errorMessage){t.createEl("div",{cls:"mayacite-error"},r=>{r.createEl("span",{text:this.errorMessage})});return}if(this.results.length===0){t.createEl("div",{cls:"mayacite-empty"},r=>{r.createEl("span",{text:"No results yet. Place your cursor and press Cmd/Ctrl+Shift+C."})}),this.renderBibliography(t);return}this.renderSelectionBar(t),this.selectedRecs.size>0?t.classList.add("has-selection"):t.classList.remove("has-selection");let e=t.createEl("div",{cls:"mayacite-results"});for(let r of this.results){let o=e.createEl("div",{cls:"mayacite-result"});if(o.createEl("div",{cls:"mayacite-result-rank"},a=>{var h;let p=a.createEl("input",{type:"checkbox",cls:"mayacite-select-checkbox"});p.checked=this.selectedRecs.has(r.paper_id),p.addEventListener("change",()=>{p.checked?this.selectedRecs.set(r.paper_id,r):this.selectedRecs.delete(r.paper_id),this.renderSelectionBarUpdate()}),a.createEl("span",{cls:"mayacite-rank-number",text:`${r.rank}.`});let d=(h=r.confidence)!=null?h:0,f=`mayacite-confidence-${F(d)}`;a.createEl("span",{cls:`mayacite-confidence ${f}`,text:d.toFixed(2),attr:{title:`Confidence: ${d.toFixed(3)}`}})}),o.createEl("div",{cls:"mayacite-result-title",text:r.title}),r.authors||r.year){let a=[];if(r.authors&&r.authors.length>0){let p=r.authors.slice(0,3).join(", ");a.push(r.authors.length>3?`${p} et al.`:p)}r.year&&a.push(`(${r.year})`),o.createEl("div",{cls:"mayacite-result-meta",text:a.join(" ")})}if(this.settings.showParagraphs){if((s=r.matched_paragraphs)!=null&&s.length)r.matched_paragraphs.forEach((a,p)=>{let d=o.createEl("blockquote",{cls:p===0?"mayacite-paragraph":"mayacite-paragraph mayacite-paragraph-secondary"});a.score!=null&&d.createEl("span",{cls:"mayacite-evidence-score",text:`${(a.score*100).toFixed(0)}%`}),this.renderHighlightedText(a.text,d,350)});else if(r.matched_paragraph){let a=o.createEl("blockquote",{cls:"mayacite-paragraph"});this.renderHighlightedText(r.matched_paragraph,a,350)}}let l=o.createEl("div",{cls:"mayacite-result-actions"}),c=l.createEl("button",{cls:"mayacite-insert-btn",text:"Insert"});(0,T.setIcon)(c.createSpan({cls:"mayacite-insert-icon"}),"plus"),c.addEventListener("click",()=>{this.onInsert(r)}),this.isTracked(r.paper_id)&&l.createEl("span",{cls:"mayacite-cited-badge",text:"Cited",attr:{title:"Already cited in this document"}})}this.renderBibliography(t)}renderSelectionBar(t){let e=t.createEl("div",{cls:"mayacite-selection-bar",attr:{style:this.selectedRecs.size>0?"":"display:none"}});e.dataset.selectionBar="true",e.createEl("span",{cls:"mayacite-selection-count",text:`${this.selectedRecs.size} selected`}),e.createEl("button",{cls:"mayacite-insert-btn",text:"Insert Selected"}).addEventListener("click",()=>{let o=Array.from(this.selectedRecs.values());o.length>0&&(this.onInsertMulti(o),this.selectedRecs.clear(),this.render())}),e.createEl("button",{cls:"mayacite-clear-btn",text:"Clear"}).addEventListener("click",()=>{this.selectedRecs.clear(),this.render()})}renderSelectionBarUpdate(){let t=this.containerEl.children[1],e=t.querySelector("[data-selection-bar]");if(e)if(this.selectedRecs.size>0){e.style.display="",t.classList.add("has-selection");let s=e.querySelector(".mayacite-selection-count");s&&(s.textContent=`${this.selectedRecs.size} selected`)}else e.style.display="none",t.classList.remove("has-selection")}renderBibliography(t){var l;if(this.trackedCitations.length===0&&!this.onExportBibliography)return;let e=t.createEl("div",{cls:"mayacite-bibliography"}),s=e.createEl("div",{cls:"mayacite-bib-header"}),r=s.createEl("span",{cls:"mayacite-bib-toggle"});if((0,T.setIcon)(r,this.bibExpanded?"chevron-down":"chevron-right"),s.createEl("span",{text:`Bibliography (${this.trackedCitations.length} citations)`}),s.addEventListener("click",()=>{this.bibExpanded=!this.bibExpanded,this.render()}),!this.bibExpanded)return;if(this.onExportBibliography&&this.trackedCitations.length>0){let c=e.createEl("div",{cls:"mayacite-bib-export"});for(let a of["BibTeX","RIS","Text"])c.createEl("button",{cls:"mayacite-export-btn",text:a}).addEventListener("click",()=>{this.onExportBibliography(a.toLowerCase())})}if(this.trackedCitations.length===0){e.createEl("div",{cls:"mayacite-bib-empty",text:"No citations tracked yet. Insert a citation to begin."});return}let o=e.createEl("div",{cls:"mayacite-bib-list"});for(let c of this.trackedCitations){let a=o.createEl("div",{cls:"mayacite-bib-item"}),p=c.authors.length>0&&(l=c.authors[0].split(/\s+/).pop())!=null?l:"",d=c.year?`${p} (${c.year})`:p;if(a.createEl("span",{cls:"mayacite-bib-label",text:d,attr:{title:c.title}}),a.createEl("span",{cls:"mayacite-bib-title",text:c.title}),this.onRemoveCitation){let u=a.createEl("button",{cls:"mayacite-bib-remove",attr:{title:"Remove from bibliography"}});(0,T.setIcon)(u,"x"),u.addEventListener("click",()=>{this.onRemoveCitation(c.paper_id)})}}}renderHighlightedText(t,e,s){let r=t.indexOf("**"),o=t.indexOf("**",r+2);if(r===-1||o===-1){let x=t.length>s?t.slice(0,s)+"...":t;e.appendText(x);return}let l=o+2,c=l-r,a=s-c,p=Math.floor(a*.3),d=a-p,u=Math.max(0,r-p),f=Math.min(t.length,l+d),h=t.slice(u,f),R=u>0,$=f<t.length;if(R){let b=h.indexOf(" ");b>0&&b<20&&(h=h.slice(b+1)),h="..."+h}$&&(h=h+"...");let K=h.split(/(\*\*.+?\*\*)/g);for(let b of K)if(b.startsWith("**")&&b.endsWith("**")){let x=b.slice(2,-2);e.createEl("strong",{text:x})}else b&&e.appendText(b)}};var G=class extends y.Plugin{constructor(){super(...arguments);this.settings=v;this.client=new O({apiMode:v.apiMode,cloudUrl:v.cloudUrl,localUrl:v.localUrl,apiToken:v.apiToken});this.watcher=null;this.lastEditor=null;this.tracker=null;this.citationStorage=null}async onload(){await this.loadSettings(),this.citationStorage=new q(this),this.registerView(k,t=>new z(t,this.settings,e=>this.insertCitation(e),e=>this.insertMultiCitation(e),e=>{var s,r;return(r=(s=this.tracker)==null?void 0:s.isTracked(e))!=null?r:!1})),this.addCommand({id:"recommend-at-cursor",name:"Get citation recommendations",editorCallback:t=>{this.recommendAtCursor(t)},hotkeys:[{modifiers:["Mod","Shift"],key:"c"}]}),this.addCommand({id:"open-sidebar",name:"Open recommendations panel",callback:()=>{this.activateSidebar()}}),this.app.workspace.on("active-leaf-change",()=>{this.initTrackerForActiveFile()}),await this.initTrackerForActiveFile(),this.settings.autoDetectEnabled&&this.startWatcher(),this.addSettingTab(new W(this.app,this))}onunload(){this.stopWatcher()}async loadSettings(){let t=await this.loadData();t!=null&&t.apiUrl&&!(t!=null&&t.apiMode)&&(t.localUrl=t.apiUrl,t.apiMode="local",delete t.apiUrl),this.settings=Object.assign({},v,t),this.client.updateConfig({apiMode:this.settings.apiMode,cloudUrl:this.settings.cloudUrl,localUrl:this.settings.localUrl,apiToken:this.settings.apiToken})}async saveSettings(){await this.saveData(this.settings),this.client.updateConfig({apiMode:this.settings.apiMode,cloudUrl:this.settings.cloudUrl,localUrl:this.settings.localUrl,apiToken:this.settings.apiToken});let t=this.getSidebarView();t&&t.updateSettings(this.settings),this.settings.autoDetectEnabled?this.startWatcher():this.stopWatcher()}async initTrackerForActiveFile(){var s;if(!this.citationStorage)return;let t=this.app.workspace.getActiveFile(),e=(s=t==null?void 0:t.path)!=null?s:"__no_file__";this.tracker=new C(this.citationStorage,e),await this.tracker.load(),this.refreshBibliography()}refreshBibliography(){let t=this.getSidebarView();!t||!this.tracker||t.setBibliography(this.tracker.getAll(),e=>this.removeCitation(e),e=>this.exportBibliography(e))}async removeCitation(t){this.tracker&&(await this.tracker.remove(t),this.refreshBibliography())}exportBibliography(t){if(!this.tracker)return;let e=this.tracker.getAll();if(e.length===0){new y.Notice("No citations to export.");return}let s;switch(t){case"bibtex":s=D(e);break;case"ris":s=j(e);break;case"text":s=N(e);break;default:new y.Notice(`Unknown format: ${t}`);return}navigator.clipboard.writeText(s).then(()=>{new y.Notice(`${t.toUpperCase()} copied to clipboard (${e.length} citations).`)})}async activateSidebar(){let t=this.app.workspace.getLeavesOfType(k);if(t.length>0){this.app.workspace.revealLeaf(t[0]);return}let e=this.app.workspace.getRightLeaf(!1);e&&(await e.setViewState({type:k,active:!0}),this.app.workspace.revealLeaf(e))}getSidebarView(){let t=this.app.workspace.getLeavesOfType(k);return t.length>0?t[0].view:null}async recommendAtCursor(t){this.lastEditor=t,await this.activateSidebar();let e=this.getSidebarView(),s=t.getSelection(),r,o;if(s&&s.trim().length>0)r=s.trim();else{let l=t.getValue(),c=t.getCursor(),a=t.posToOffset(c),p=L(l,a,this.settings.contextSentences);r=p.text,o=p.cursorSentenceIndex}if(!r.trim()){e&&e.setError("No text around cursor to use as context.");return}e&&e.setLoading();try{let l=await this.client.recommend(r,this.settings.k,this.settings.authorBoost,o);e&&(e.setResults(l.recommendations),this.refreshBibliography())}catch(l){let c=l instanceof Error?l.message:"Failed to connect";if(this.settings.apiMode==="cloud")e&&e.setError(`Could not reach inCite cloud. Check your API token. (${c})`),new y.Notice("inCite: Could not reach cloud. Check your API token.");else{let a=P(this.settings);e&&e.setError(`Could not reach inCite at ${a}. Is 'incite serve' running? (${c})`),new y.Notice("inCite: Server not reachable. Run 'incite serve'.")}}}insertCitation(t){var a,p,d,u;let e=(d=(p=this.lastEditor)!=null?p:(a=this.app.workspace.activeEditor)==null?void 0:a.editor)!=null?d:null;if(!e){new y.Notice("No active editor to insert citation into.");return}let s="Unknown";if(t.authors&&t.authors.length>0){let f=t.authors[0].trim().split(/\s+/);s=f[f.length-1],t.authors.length>1&&(s+=" et al.")}let r=`zotero://select/items/0_${t.paper_id}`,o=this.settings.insertFormat.replace("{bibtex_key}",t.bibtex_key||t.paper_id).replace("{paper_id}",t.paper_id).replace("{first_author}",s).replace("{year}",String((u=t.year)!=null?u:"n.d.")).replace("{title}",t.title).replace("{zotero_uri}",t.zotero_uri||r),l=e.getCursor();e.replaceRange(o,l);let c=e.posToOffset(l)+o.length;e.setCursor(e.offsetToPos(c)),this.tracker&&this.tracker.track([t]).then(()=>this.refreshBibliography()),new y.Notice(`Inserted: ${o}`)}insertMultiCitation(t){var l,c,a;let e=(a=(c=this.lastEditor)!=null?c:(l=this.app.workspace.activeEditor)==null?void 0:l.editor)!=null?a:null;if(!e){new y.Notice("No active editor to insert citations into.");return}let s=U(t,this.settings.insertFormat),r=e.getCursor();e.replaceRange(s,r);let o=e.posToOffset(r)+s.length;e.setCursor(e.offsetToPos(o)),this.tracker&&this.tracker.track(t).then(()=>this.refreshBibliography()),new y.Notice(`Inserted ${t.length} citations.`)}startWatcher(){this.watcher||(this.watcher=new V(this.app,this.settings,t=>this.recommendAtCursor(t)),this.watcher.start(this))}stopWatcher(){this.watcher&&(this.watcher.stop(),this.watcher=null)}};
