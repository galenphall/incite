var X=Object.defineProperty;var rt=Object.getOwnPropertyDescriptor;var ot=Object.getOwnPropertyNames;var at=Object.prototype.hasOwnProperty;var ct=(n,i)=>{for(var t in i)X(n,t,{get:i[t],enumerable:!0})},lt=(n,i,t,e)=>{if(i&&typeof i=="object"||typeof i=="function")for(let s of ot(i))!at.call(n,s)&&s!==t&&X(n,s,{get:()=>i[s],enumerable:!(e=rt(i,s))||e.enumerable});return n};var dt=n=>lt(X({},"__esModule",{value:!0}),n);var ft={};ct(ft,{default:()=>K});module.exports=dt(ft);var b=require("obsidian");var Q=require("obsidian");var P={apiMode:"cloud",cloudUrl:"https://inciteref.com",localUrl:"http://127.0.0.1:8230",apiToken:"",k:10,authorBoost:1,contextSentences:6,citationPatterns:["\\[@[^\\]]*\\]","\\[cite\\]","\\\\cite\\{[^}]*\\}"],insertFormat:"({first_author}, {year})",autoDetectEnabled:!1,debounceMs:500,showParagraphs:!0,collectionId:null};function M(n){return n.apiMode==="cloud"?n.cloudUrl:n.localUrl}var A=class{async get(i,t){let e=await fetch(i,{method:"GET",headers:{Accept:"application/json",...t}});if(!e.ok)throw new Error(`HTTP ${e.status}: ${e.statusText}`);return e.json()}async post(i,t,e){let s=await fetch(i,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json",...e},body:JSON.stringify(t)});if(!s.ok)throw new Error(`HTTP ${s.status}: ${s.statusText}`);return s.json()}},w=class{constructor(i,t){typeof i=="string"?this.config={apiMode:"local",cloudUrl:"https://inciteref.com",localUrl:i,apiToken:""}:this.config={...i},this.transport=t!=null?t:new A}updateConfig(i){Object.assign(this.config,i)}setBaseUrl(i){this.config.localUrl=i}getBaseUrl(){return this.config.apiMode==="cloud"?this.config.cloudUrl:this.config.localUrl}getAuthHeaders(){return this.config.apiMode==="cloud"&&this.config.apiToken?{Authorization:`Bearer ${this.config.apiToken}`}:{}}getEndpoint(i){if(this.config.apiMode==="cloud")switch(i){case"/health":return"/api/v1/health";case"/recommend":return"/api/v1/recommend";default:return i}return i}async authGet(i){let t=`${this.getBaseUrl()}${this.getEndpoint(i)}`;return this.transport.get(t,this.getAuthHeaders())}async authPost(i,t){let e=`${this.getBaseUrl()}${this.getEndpoint(i)}`;return this.transport.post(e,t,this.getAuthHeaders())}async health(){let t=await this.authGet("/health");return this.config.apiMode==="cloud"&&t.ready===void 0?{...t,ready:t.status==="ready"}:t}async recommend(i,t,e,s,o){let r={query:i,k:t,author_boost:e};return s!==void 0&&(r.cursor_sentence_index=s),o&&(r.collection_id=o),await this.authPost("/recommend",r)}async savePapers(i){return await this.authPost("/api/v1/library/papers",i)}async checkLibrary(i){return(await this.authPost("/api/v1/library/check",{papers:i})).results}async getCollections(){return(await this.authGet("/api/v1/library/collections")).collections}async searchTags(i){let t=encodeURIComponent(i);return(await this.authGet(`/api/v1/library/tags/search?q=${t}`)).tags}async serverConfig(){let i=`${this.config.localUrl}/config`;return this.transport.get(i)}async libraryStatus(){return this.authGet("/api/v1/upload-library/status")}async libraryRefresh(){return this.authPost("/api/library/refresh",{})}};function Y(n){let i=/(?:Dr|Mr|Mrs|Ms|Prof|Sr|Jr|etc|Fig|Figs|Eq|Eqs|al|vs|i\.e|e\.g|cf|no|vol|pp|ed|Rev|Jan|Feb|Mar|Apr|Jun|Jul|Aug|Sep|Oct|Nov|Dec)\.\s*/gi,t="\0";return n.replace(i,o=>o.replace(/\.\s*/,t)).split(/(?<=[.!?])\s+(?=[A-Z"])/).map(o=>o.replace(new RegExp(t,"g"),". ").trim()).filter(o=>o.length>0)}function L(n){return n.replace(/\[@[^\]]*\]/g,"").replace(/\[cite\]/gi,"").replace(/\\cite\{[^}]*\}/g,"").replace(/\s{2,}/g," ").trim()}function B(n,i,t){let e=n.split(`
`),s=0,o=0;for(let f=0;f<e.length;f++)if(s+=e[f].length+1,s>i){o=f;break}let r=50,a=Math.max(0,o-r),l=Math.min(e.length,o+r),c=e.slice(a,l).join(`
`),d=0;for(let f=0;f<a;f++)d+=e[f].length+1;let g=i-d,p=Y(c);if(p.length===0)return{text:L(c),rawText:c,cursorSentenceIndex:0,totalSentences:0};let u=0,h=0;for(let f=0;f<p.length;f++){let I=c.indexOf(p[f],u);if(I===-1)continue;let it=I+p[f].length;if(g>=I&&g<=it){h=f;break}if(I>g){h=Math.max(0,f-1);break}u=it,h=f}let y=Math.floor(t/2),x=Math.max(0,h-y),J=Math.min(p.length,h+y+1),v=p.slice(x,J),T=v.join(" ");return{text:L(T),rawText:T,cursorSentenceIndex:h-x,totalSentences:v.length}}var R=class{constructor(i,t){this.debounceTimer=null;this.settings=i,this.onTrigger=t}updateSettings(i){this.settings=i}checkLine(i){this.settings.citationPatterns.some(e=>{try{return new RegExp(e).test(i)}catch(s){return!1}})&&(this.debounceTimer&&clearTimeout(this.debounceTimer),this.debounceTimer=setTimeout(()=>{this.debounceTimer=null,this.onTrigger()},this.settings.debounceMs))}dispose(){this.debounceTimer&&(clearTimeout(this.debounceTimer),this.debounceTimer=null)}};function U(n,i){var r,a,l,c,d,g,p;let t=(r=n.authors)!=null&&r[0]&&(a=n.authors[0].split(",")[0].split(" ").pop())!=null?a:"",e=t&&n.year?`${t}${n.year}`:t||((l=n.title)==null?void 0:l.split(/\s+/).slice(0,3).join(""))||n.paper_id,s={bibtex_key:(c=n.bibtex_key)!=null?c:e,paper_id:n.paper_id,first_author:t,year:(g=(d=n.year)==null?void 0:d.toString())!=null?g:"",title:n.title,zotero_uri:(p=n.zotero_uri)!=null?p:""},o=i;for(let[u,h]of Object.entries(s))o=o.replace(new RegExp(`\\{${u}\\}`,"g"),h),o=o.replace(new RegExp(`\\$\\{${u}\\}`,"g"),h);return o}function nt(n){return/\\cite\{/.test(n)?"latex":/\[@/.test(n)?"pandoc":"individual"}function H(n,i,t="; "){if(n.length===0)return"";if(n.length===1)return U(n[0],i);switch(nt(i)){case"latex":return`\\cite{${n.map(o=>{var r;return(r=o.bibtex_key)!=null?r:o.paper_id}).join(",")}}`;case"pandoc":return`[@${n.map(o=>{var r;return(r=o.bibtex_key)!=null?r:o.paper_id}).join("; @")}]`;case"individual":{let s=n.map(l=>U(l,i)),o=s[0],a=[["(",")"],["[","]"]].find(([l,c])=>o.startsWith(l)&&o.endsWith(c));if(a){let[l,c]=a,d=s.map(g=>g.slice(1,-1));return`${l}${d.join(t)}${c}`}return s.join(t)}}}function Z(n){var i,t;return{paper_id:n.paper_id,bibtex_key:(i=n.bibtex_key)!=null?i:n.paper_id,title:n.title,authors:(t=n.authors)!=null?t:[],year:n.year,doi:n.doi,journal:n.journal,abstract:n.abstract,insertedAt:Date.now()}}var k=class{constructor(i,t){this.citations=[];this.storage=i,this.docKey=t}async load(){this.citations=await this.storage.load(this.docKey)}async track(i){for(let t of i)this.isTracked(t.paper_id)||this.citations.push(Z(t));await this.storage.save(this.docKey,this.citations)}async remove(i){this.citations=this.citations.filter(t=>t.paper_id!==i),await this.storage.save(this.docKey,this.citations)}getAll(){return[...this.citations].sort((i,t)=>i.insertedAt-t.insertedAt)}isTracked(i){return this.citations.some(t=>t.paper_id===i)}get count(){return this.citations.length}};var pt={"\\":"\\textbackslash{}","{":"\\{","}":"\\}","&":"\\&","%":"\\%","#":"\\#",_:"\\_","~":"\\textasciitilde{}","^":"\\textasciicircum{}"};function _(n){var t;let i="";for(let e of n)i+=(t=pt[e])!=null?t:e;return i}function gt(n){let i=n.bibtex_key||n.paper_id,t=[];return t.push(`  title = {${_(n.title)}}`),n.authors.length>0&&t.push(`  author = {${_(n.authors.join(" and "))}}`),n.year!=null&&t.push(`  year = {${n.year}}`),n.journal&&t.push(`  journal = {${_(n.journal)}}`),n.doi&&t.push(`  doi = {${n.doi}}`),n.abstract&&t.push(`  abstract = {${_(n.abstract)}}`),`@article{${i},
${t.join(`,
`)}
}`}function F(n){return n.map(gt).join(`

`)}function ht(n){let i=[];i.push("TY  - JOUR"),i.push(`TI  - ${n.title}`);for(let t of n.authors)i.push(`AU  - ${t}`);return n.year!=null&&i.push(`PY  - ${n.year}`),n.doi&&i.push(`DO  - ${n.doi}`),n.journal&&i.push(`JO  - ${n.journal}`),n.abstract&&i.push(`AB  - ${n.abstract}`),i.push("ER  - "),i.join(`
`)}function j(n){return n.map(ht).join(`

`)}function D(n){if(n.includes(","))return n.split(",")[0].trim();let i=n.trim().split(/\s+/);return i[i.length-1]}function ut(n){let i=[];if(n.authors.length>0)if(n.authors.length<=2)i.push(n.authors.map(D).join(" & "));else{let t=n.authors.map(D),e=t.slice(0,-1).join(", ");i.push(`${e}, & ${t[t.length-1]}`)}return i.push(n.year!=null?`(${n.year}).`:"(n.d.)."),i.push(`${n.title}.`),n.journal&&i.push(`${n.journal}.`),n.doi&&i.push(`https://doi.org/${n.doi}`),i.join(" ")}function $(n){return[...n].sort((t,e)=>{let s=t.authors.length>0?D(t.authors[0]):"",o=e.authors.length>0?D(e.authors[0]):"";return s.localeCompare(o)}).map(ut).join(`

`)}function N(n){return n>=.55?"high":n>=.35?"mid":"low"}var tt=class{async get(i,t){let e={url:i,method:"GET",headers:t?{...t}:void 0};return(await(0,Q.requestUrl)(e)).json}async post(i,t,e){let s={url:i,method:"POST",headers:{"Content-Type":"application/json",...e},body:JSON.stringify(t)};return(await(0,Q.requestUrl)(s)).json}},O=class extends w{constructor(i){super(i,new tt)}};var V=class{constructor(i,t,e){this.eventRef=null;this.lastEditor=null;this.app=i,this.onTrigger=e,this.core=new R(t,()=>{this.lastEditor&&this.onTrigger(this.lastEditor)})}start(i){this.eventRef=this.app.workspace.on("editor-change",t=>{this.lastEditor=t;let e=t.getCursor(),s=t.getLine(e.line);this.core.checkLine(s)}),i.registerEvent(this.eventRef)}stop(){this.core.dispose(),this.eventRef=null,this.lastEditor=null}updateSettings(i){this.core.updateSettings(i)}};var et="incite-tracked-citations",W=class{constructor(i){this.plugin=i}async load(i){var s,o;let t=await this.plugin.loadData();return(o=((s=t==null?void 0:t[et])!=null?s:{})[i])!=null?o:[]}async save(i,t){var o,r;let e=(o=await this.plugin.loadData())!=null?o:{},s=(r=e[et])!=null?r:{};s[i]=t,e[et]=s,await this.plugin.saveData(e)}};var st="incite-citations";function mt(n){let{abstract:i,...t}=n;return t}var q=class{constructor(i){this.app=i}async load(i){var o;let t=this.resolveFile(i);if(!t)return[];let e=this.app.metadataCache.getFileCache(t),s=(o=e==null?void 0:e.frontmatter)==null?void 0:o[st];return Array.isArray(s)?s:[]}async save(i,t){let e=this.resolveFile(i);if(!e)return;let s=t.map(mt);await this.app.fileManager.processFrontMatter(e,o=>{o[st]=s})}resolveFile(i){let t=this.app.vault.getAbstractFileByPath(i);return!t||!("stat"in t)?null:t}};var m=require("obsidian"),z=class extends m.PluginSettingTab{constructor(i,t){super(i,t),this.plugin=t}display(){let{containerEl:i}=this;i.empty(),i.createEl("h3",{text:"Server"}),new m.Setting(i).setName("API mode").setDesc("Connect to the inCite cloud service or a local server").addDropdown(t=>t.addOption("cloud","Cloud (inciteref.com)").addOption("local","Local (incite serve)").setValue(this.plugin.settings.apiMode).onChange(async e=>{this.plugin.settings.apiMode=e,await this.plugin.saveSettings(),this.display()})),this.plugin.settings.apiMode==="cloud"?(new m.Setting(i).setName("API token").setDesc("Your inCite API token (from inciteref.com account settings)").addText(t=>t.setPlaceholder("Enter your API token").setValue(this.plugin.settings.apiToken).onChange(async e=>{this.plugin.settings.apiToken=e,await this.plugin.saveSettings()})),new m.Setting(i).setName("Cloud URL").setDesc("inCite cloud server URL").addText(t=>t.setPlaceholder("https://inciteref.com").setValue(this.plugin.settings.cloudUrl).onChange(async e=>{this.plugin.settings.cloudUrl=e,await this.plugin.saveSettings()}))):new m.Setting(i).setName("Local URL").setDesc("URL of the local inCite server (run 'incite serve')").addText(t=>t.setPlaceholder("http://127.0.0.1:8230").setValue(this.plugin.settings.localUrl).onChange(async e=>{this.plugin.settings.localUrl=e,await this.plugin.saveSettings()})),new m.Setting(i).setName("Test connection").setDesc("Check if the inCite server is reachable").addButton(t=>t.setButtonText("Test").onClick(async()=>{try{let e=await this.plugin.client.health();e.ready?new m.Notice(`Connected! ${e.corpus_size} papers, mode: ${e.mode||"paper"}`):new m.Notice("Server is loading, try again in a moment.")}catch(e){this.plugin.settings.apiMode==="cloud"?new m.Notice("Could not connect. Check your API token and server URL."):new m.Notice("Could not connect. Is 'incite serve' running?")}})),i.createEl("h3",{text:"Retrieval"}),new m.Setting(i).setName("Number of results").setDesc("How many recommendations to show").addSlider(t=>t.setLimits(1,50,1).setValue(this.plugin.settings.k).setDynamicTooltip().onChange(async e=>{this.plugin.settings.k=e,await this.plugin.saveSettings()})),new m.Setting(i).setName("Author boost").setDesc("Boost papers whose authors appear in context (1.0 = no boost, 1.2 = 20% boost)").addText(t=>t.setPlaceholder("1.0").setValue(String(this.plugin.settings.authorBoost)).onChange(async e=>{let s=parseFloat(e);!isNaN(s)&&s>=0&&s<=5&&(this.plugin.settings.authorBoost=s,await this.plugin.saveSettings())})),new m.Setting(i).setName("Context sentences").setDesc("Total sentences to extract around cursor (split before/after)").addSlider(t=>t.setLimits(2,20,1).setValue(this.plugin.settings.contextSentences).setDynamicTooltip().onChange(async e=>{this.plugin.settings.contextSentences=e,await this.plugin.saveSettings()})),i.createEl("h3",{text:"Citation format"}),new m.Setting(i).setName("Insert format").setDesc("Placeholders: {first_author}, {year}, {paper_id}, {bibtex_key}, {title}").addText(t=>t.setPlaceholder("[({first_author}, {year})](zotero://.../{paper_id})").setValue(this.plugin.settings.insertFormat).onChange(async e=>{this.plugin.settings.insertFormat=e,await this.plugin.saveSettings()})),i.createEl("h3",{text:"Auto-detection"}),new m.Setting(i).setName("Enable auto-detection").setDesc("Automatically trigger recommendations when a citation marker is detected").addToggle(t=>t.setValue(this.plugin.settings.autoDetectEnabled).onChange(async e=>{this.plugin.settings.autoDetectEnabled=e,await this.plugin.saveSettings()})),new m.Setting(i).setName("Debounce delay (ms)").setDesc("Wait this long after typing before triggering (default: 500)").addText(t=>t.setPlaceholder("500").setValue(String(this.plugin.settings.debounceMs)).onChange(async e=>{let s=parseInt(e);!isNaN(s)&&s>=100&&s<=5e3&&(this.plugin.settings.debounceMs=s,await this.plugin.saveSettings())})),i.createEl("h3",{text:"Display"}),new m.Setting(i).setName("Show matched paragraphs").setDesc("Display paragraph evidence when the server runs in paragraph mode").addToggle(t=>t.setValue(this.plugin.settings.showParagraphs).onChange(async e=>{this.plugin.settings.showParagraphs=e,await this.plugin.saveSettings()}))}};var S=require("obsidian");var C={...P,apiMode:"local",insertFormat:"[({first_author}, {year})]({zotero_uri})",autoDetectEnabled:!0,debounceMs:500};var E="incite-sidebar",G=class extends S.ItemView{constructor(t,e,s,o,r){super(t);this.results=[];this.loading=!1;this.errorMessage=null;this.selectedRecs=new Map;this.collections=[];this.onCollectionChange=null;this.trackedCitations=[];this.onRemoveCitation=null;this.onExportBibliography=null;this.onInsertBibliography=null;this.bibExpanded=!1;this.settings=e,this.onInsert=s,this.onInsertMulti=o,this.isTracked=r}getViewType(){return E}getDisplayText(){return"inCite"}getIcon(){return"book-open"}async onOpen(){this.render()}async onClose(){}updateSettings(t){this.settings=t}setCollections(t,e){this.collections=t,this.onCollectionChange=e,this.render()}setBibliography(t,e,s,o){this.trackedCitations=t,this.onRemoveCitation=e,this.onExportBibliography=s,this.onInsertBibliography=o,this.render()}updateTrackedCitations(t){this.trackedCitations=t,this.render()}setLoading(){this.loading=!0,this.errorMessage=null,this.render()}setError(t){this.loading=!1,this.errorMessage=t,this.results=[],this.render()}setResults(t){this.loading=!1,this.errorMessage=null,this.results=t,this.selectedRecs.clear(),this.render()}render(){var s,o;let t=this.containerEl.children[1];if(t.empty(),t.createEl("div",{cls:"mayacite-header"},r=>{r.createEl("h4",{text:"inCite"})}),this.settings.apiMode==="cloud"&&this.collections.length>0&&t.createEl("div",{cls:"mayacite-collection-filter"},r=>{let a=r.createEl("select",{cls:"mayacite-collection-select"}),l=a.createEl("option",{text:"All papers",value:""});this.settings.collectionId||(l.selected=!0);for(let c of this.collections){let d=a.createEl("option",{text:`${c.name} (${c.item_count})`,value:String(c.id)});this.settings.collectionId===String(c.id)&&(d.selected=!0)}a.addEventListener("change",()=>{var d;let c=a.value||null;(d=this.onCollectionChange)==null||d.call(this,c)})}),this.loading){t.createEl("div",{cls:"mayacite-loading"},r=>{r.createEl("span",{text:"Searching..."})});return}if(this.errorMessage){t.createEl("div",{cls:"mayacite-error"},r=>{r.createEl("span",{text:this.errorMessage})});return}if(this.results.length===0){t.createEl("div",{cls:"mayacite-empty"},r=>{r.createEl("span",{text:"No results yet. Place your cursor and press Cmd/Ctrl+Shift+C."})}),this.renderBibliography(t);return}this.renderSelectionBar(t),this.selectedRecs.size>0?t.classList.add("has-selection"):t.classList.remove("has-selection");let e=t.createEl("div",{cls:"mayacite-results"});for(let r of this.results){let a=e.createEl("div",{cls:"mayacite-result"});if(a.createEl("div",{cls:"mayacite-result-rank"},d=>{var x;let g=d.createEl("input",{type:"checkbox",cls:"mayacite-select-checkbox"});g.checked=this.selectedRecs.has(r.paper_id),g.addEventListener("change",()=>{g.checked?this.selectedRecs.set(r.paper_id,r):this.selectedRecs.delete(r.paper_id),this.renderSelectionBarUpdate()}),d.createEl("span",{cls:"mayacite-rank-number",text:`${r.rank}.`});let p=(x=r.confidence)!=null?x:0,h=`mayacite-confidence-${N(p)}`,y=p>=.55?"Strong":p>=.35?"Good":"Weak";d.createEl("span",{cls:`mayacite-confidence ${h}`,text:y,attr:{title:`Score: ${p.toFixed(3)}`}})}),a.createEl("div",{cls:"mayacite-result-title",text:r.title}),r.authors||r.year){let d=[];if(r.authors&&r.authors.length>0){let g=r.authors.slice(0,3).join(", ");d.push(r.authors.length>3?`${g} et al.`:g)}r.year&&d.push(`(${r.year})`),a.createEl("div",{cls:"mayacite-result-meta",text:d.join(" ")})}if(this.settings.showParagraphs&&(((s=r.matched_paragraphs)==null?void 0:s.length)||r.matched_paragraph)){let g=a.createEl("button",{cls:"mayacite-evidence-toggle",text:"Show evidence \u25BE"}),p=a.createEl("div",{cls:"mayacite-evidence-content"});if((o=r.matched_paragraphs)!=null&&o.length)r.matched_paragraphs.forEach((u,h)=>{let y=p.createEl("blockquote",{cls:h===0?"mayacite-paragraph":"mayacite-paragraph mayacite-paragraph-secondary"});u.score!=null&&y.createEl("span",{cls:"mayacite-evidence-score",text:`${(u.score*100).toFixed(0)}%`}),this.renderHighlightedText(u.text,y,350)});else if(r.matched_paragraph){let u=p.createEl("blockquote",{cls:"mayacite-paragraph"});this.renderHighlightedText(r.matched_paragraph,u,350)}g.addEventListener("click",()=>{let u=p.classList.toggle("expanded");g.textContent=u?"Hide evidence \u25B4":"Show evidence \u25BE"})}let l=a.createEl("div",{cls:"mayacite-result-actions"}),c=l.createEl("button",{cls:"mayacite-insert-btn",text:"Insert"});(0,S.setIcon)(c.createSpan({cls:"mayacite-insert-icon"}),"plus"),c.addEventListener("click",()=>{this.onInsert(r)}),this.isTracked(r.paper_id)&&l.createEl("span",{cls:"mayacite-cited-badge",text:"Cited",attr:{title:"Already cited in this document"}})}this.renderBibliography(t)}renderSelectionBar(t){let e=t.createEl("div",{cls:"mayacite-selection-bar",attr:{style:this.selectedRecs.size>0?"":"display:none"}});e.dataset.selectionBar="true",e.createEl("span",{cls:"mayacite-selection-count",text:`${this.selectedRecs.size} selected`}),e.createEl("button",{cls:"mayacite-insert-btn",text:"Insert Selected"}).addEventListener("click",()=>{let r=Array.from(this.selectedRecs.values());r.length>0&&(this.onInsertMulti(r),this.selectedRecs.clear(),this.render())}),e.createEl("button",{cls:"mayacite-clear-btn",text:"Clear"}).addEventListener("click",()=>{this.selectedRecs.clear(),this.render()})}renderSelectionBarUpdate(){let t=this.containerEl.children[1],e=t.querySelector("[data-selection-bar]");if(e)if(this.selectedRecs.size>0){e.style.display="",t.classList.add("has-selection");let s=e.querySelector(".mayacite-selection-count");s&&(s.textContent=`${this.selectedRecs.size} selected`)}else e.style.display="none",t.classList.remove("has-selection")}renderBibliography(t){var a;if(this.trackedCitations.length===0&&!this.onExportBibliography)return;let e=t.createEl("div",{cls:"mayacite-bibliography"}),s=e.createEl("div",{cls:"mayacite-bib-header"}),o=s.createEl("span",{cls:"mayacite-bib-toggle"});if((0,S.setIcon)(o,this.bibExpanded?"chevron-down":"chevron-right"),s.createEl("span",{text:`Bibliography (${this.trackedCitations.length} citations)`}),s.addEventListener("click",()=>{this.bibExpanded=!this.bibExpanded,this.render()}),!this.bibExpanded)return;if(this.onExportBibliography&&this.trackedCitations.length>0){let l=e.createEl("div",{cls:"mayacite-bib-export"});for(let c of["BibTeX","RIS","Text"])l.createEl("button",{cls:"mayacite-export-btn",text:c}).addEventListener("click",()=>{this.onExportBibliography(c.toLowerCase())});this.onInsertBibliography&&l.createEl("button",{cls:"mayacite-export-btn",text:"Insert"}).addEventListener("click",()=>{this.onInsertBibliography()})}if(this.trackedCitations.length===0){e.createEl("div",{cls:"mayacite-bib-empty",text:"No citations tracked yet. Insert a citation to begin."});return}let r=e.createEl("div",{cls:"mayacite-bib-list"});for(let l of this.trackedCitations){let c=r.createEl("div",{cls:"mayacite-bib-item"}),d=l.authors.length>0&&(a=l.authors[0].split(/\s+/).pop())!=null?a:"",g=l.year?`${d} (${l.year})`:d;if(c.createEl("span",{cls:"mayacite-bib-label",text:g,attr:{title:l.title}}),c.createEl("span",{cls:"mayacite-bib-title",text:l.title}),this.onRemoveCitation){let p=c.createEl("button",{cls:"mayacite-bib-remove",attr:{title:"Remove from bibliography"}});(0,S.setIcon)(p,"x"),p.addEventListener("click",()=>{this.onRemoveCitation(l.paper_id)})}}}renderHighlightedText(t,e,s){let o=t.indexOf("**"),r=t.indexOf("**",o+2);if(o===-1||r===-1){let T=t.length>s?t.slice(0,s)+"...":t;e.appendText(T);return}let a=r+2,l=a-o,c=s-l,d=Math.floor(c*.3),g=c-d,p=Math.max(0,o-d),u=Math.min(t.length,a+g),h=t.slice(p,u),y=p>0,x=u<t.length;if(y){let v=h.indexOf(" ");v>0&&v<20&&(h=h.slice(v+1)),h="..."+h}x&&(h=h+"...");let J=h.split(/(\*\*.+?\*\*)/g);for(let v of J)if(v.startsWith("**")&&v.endsWith("**")){let T=v.slice(2,-2);e.createEl("strong",{text:T})}else v&&e.appendText(v)}};var K=class extends b.Plugin{constructor(){super(...arguments);this.settings=C;this.client=new O({apiMode:C.apiMode,cloudUrl:C.cloudUrl,localUrl:C.localUrl,apiToken:C.apiToken});this.watcher=null;this.lastEditor=null;this.tracker=null;this.citationStorage=null;this.legacyStorage=null}async onload(){await this.loadSettings(),this.citationStorage=new q(this.app),this.legacyStorage=new W(this),this.registerView(E,t=>new G(t,this.settings,e=>this.insertCitation(e),e=>this.insertMultiCitation(e),e=>{var s,o;return(o=(s=this.tracker)==null?void 0:s.isTracked(e))!=null?o:!1})),this.addCommand({id:"recommend-at-cursor",name:"Get citation recommendations",editorCallback:t=>{this.recommendAtCursor(t)},hotkeys:[{modifiers:["Mod","Shift"],key:"c"}]}),this.addCommand({id:"open-sidebar",name:"Open recommendations panel",callback:()=>{this.activateSidebar()}}),this.app.workspace.on("active-leaf-change",()=>{this.initTrackerForActiveFile()}),await this.initTrackerForActiveFile(),this.settings.autoDetectEnabled&&this.startWatcher(),this.addSettingTab(new z(this.app,this)),this.settings.apiMode==="cloud"&&this.fetchCollections()}onunload(){this.stopWatcher()}async loadSettings(){let t=await this.loadData();t!=null&&t.apiUrl&&!(t!=null&&t.apiMode)&&(t.localUrl=t.apiUrl,t.apiMode="local",delete t.apiUrl),this.settings=Object.assign({},C,t),this.client.updateConfig({apiMode:this.settings.apiMode,cloudUrl:this.settings.cloudUrl,localUrl:this.settings.localUrl,apiToken:this.settings.apiToken})}async saveSettings(){await this.saveData(this.settings),this.client.updateConfig({apiMode:this.settings.apiMode,cloudUrl:this.settings.cloudUrl,localUrl:this.settings.localUrl,apiToken:this.settings.apiToken});let t=this.getSidebarView();t&&t.updateSettings(this.settings),this.settings.autoDetectEnabled?this.startWatcher():this.stopWatcher(),this.settings.apiMode==="cloud"&&this.fetchCollections()}async initTrackerForActiveFile(){var s;if(!this.citationStorage)return;let t=this.app.workspace.getActiveFile(),e=(s=t==null?void 0:t.path)!=null?s:"__no_file__";if(this.tracker=new k(this.citationStorage,e),await this.tracker.load(),this.tracker.count===0&&this.legacyStorage){let o=await this.legacyStorage.load(e);o.length>0&&(await this.citationStorage.save(e,o),await this.tracker.load())}this.refreshBibliography()}refreshBibliography(){let t=this.getSidebarView();!t||!this.tracker||t.setBibliography(this.tracker.getAll(),e=>this.removeCitation(e),e=>this.exportBibliography(e),()=>this.insertBibliography())}async removeCitation(t){this.tracker&&(await this.tracker.remove(t),this.refreshBibliography())}exportBibliography(t){if(!this.tracker)return;let e=this.tracker.getAll();if(e.length===0){new b.Notice("No citations to export.");return}let s;switch(t){case"bibtex":s=F(e);break;case"ris":s=j(e);break;case"text":s=$(e);break;default:new b.Notice(`Unknown format: ${t}`);return}navigator.clipboard.writeText(s).then(()=>{new b.Notice(`${t.toUpperCase()} copied to clipboard (${e.length} citations).`)})}insertBibliography(){var r,a,l;let t=(l=(a=this.lastEditor)!=null?a:(r=this.app.workspace.activeEditor)==null?void 0:r.editor)!=null?l:null;if(!t){new b.Notice("No active editor to insert bibliography into.");return}if(!this.tracker||this.tracker.count===0){new b.Notice("No citations to insert.");return}let e=$(this.tracker.getAll()),s=t.getCursor();t.replaceRange(e,s);let o=t.posToOffset(s)+e.length;t.setCursor(t.offsetToPos(o)),new b.Notice(`Inserted bibliography (${this.tracker.count} citations).`)}async fetchCollections(){try{let t=await this.client.getCollections(),e=this.getSidebarView();e&&e.setCollections(t,s=>{this.settings.collectionId=s,this.saveSettings()})}catch(t){}}async activateSidebar(){let t=this.app.workspace.getLeavesOfType(E);if(t.length>0){this.app.workspace.revealLeaf(t[0]);return}let e=this.app.workspace.getRightLeaf(!1);e&&(await e.setViewState({type:E,active:!0}),this.app.workspace.revealLeaf(e))}getSidebarView(){let t=this.app.workspace.getLeavesOfType(E);return t.length>0?t[0].view:null}async recommendAtCursor(t){this.lastEditor=t,await this.activateSidebar();let e=this.getSidebarView(),s=t.getSelection(),o,r;if(s&&s.trim().length>0)o=s.trim();else{let a=t.getValue(),l=t.getCursor(),c=t.posToOffset(l),d=B(a,c,this.settings.contextSentences);o=d.text,r=d.cursorSentenceIndex}if(!o.trim()){e&&e.setError("No text around cursor to use as context.");return}e&&e.setLoading();try{let a=await this.client.recommend(o,this.settings.k,this.settings.authorBoost,r,this.settings.collectionId);e&&(e.setResults(a.recommendations),this.refreshBibliography())}catch(a){let l=a instanceof Error?a.message:"Failed to connect";if(this.settings.apiMode==="cloud")e&&e.setError(`Could not reach inCite cloud. Check your API token. (${l})`),new b.Notice("inCite: Could not reach cloud. Check your API token.");else{let c=M(this.settings);e&&e.setError(`Could not reach inCite at ${c}. Is 'incite serve' running? (${l})`),new b.Notice("inCite: Server not reachable. Run 'incite serve'.")}}}insertCitation(t){var c,d,g,p;let e=(g=(d=this.lastEditor)!=null?d:(c=this.app.workspace.activeEditor)==null?void 0:c.editor)!=null?g:null;if(!e){new b.Notice("No active editor to insert citation into.");return}let s="Unknown";if(t.authors&&t.authors.length>0){let u=t.authors[0].trim().split(/\s+/);s=u[u.length-1],t.authors.length>1&&(s+=" et al.")}let o=`zotero://select/items/0_${t.paper_id}`,r=this.settings.insertFormat.replace("{bibtex_key}",t.bibtex_key||t.paper_id).replace("{paper_id}",t.paper_id).replace("{first_author}",s).replace("{year}",String((p=t.year)!=null?p:"n.d.")).replace("{title}",t.title).replace("{zotero_uri}",t.zotero_uri||o),a=e.getCursor();e.replaceRange(r,a);let l=e.posToOffset(a)+r.length;e.setCursor(e.offsetToPos(l)),this.tracker&&this.tracker.track([t]).then(()=>this.refreshBibliography()),new b.Notice(`Inserted: ${r}`)}insertMultiCitation(t){var a,l,c;let e=(c=(l=this.lastEditor)!=null?l:(a=this.app.workspace.activeEditor)==null?void 0:a.editor)!=null?c:null;if(!e){new b.Notice("No active editor to insert citations into.");return}let s=H(t,this.settings.insertFormat),o=e.getCursor();e.replaceRange(s,o);let r=e.posToOffset(o)+s.length;e.setCursor(e.offsetToPos(r)),this.tracker&&this.tracker.track(t).then(()=>this.refreshBibliography()),new b.Notice(`Inserted ${t.length} citations.`)}startWatcher(){this.watcher||(this.watcher=new V(this.app,this.settings,t=>this.recommendAtCursor(t)),this.watcher.start(this))}stopWatcher(){this.watcher&&(this.watcher.stop(),this.watcher=null)}};
