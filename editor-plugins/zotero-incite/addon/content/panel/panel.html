<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>inCite Control Center</title>
  <style>:root {
  /* --- InCite Identity --- */
  --ink:        #1a1a1e;
  --ink-soft:   #2a2a2f;
  --ink-muted:  #4a4a52;
  --graphite:   #6b6b74;
  --slate:      #8e8e97;
  --silver:     #b8b8bf;
  --fog:        #dcdce0;
  --paper:      #f0efe9;
  --paper-warm: #f5f4ed;
  --cream:      #faf9f3;

  --oxblood:       #8b2e2e;
  --oxblood-light: #a83c3c;
  --oxblood-faint: #f2e8e8;
  --oxblood-muted: #c47070;

  --success: #3a6b4a;
  --warning: #8b6b2e;
  --error:   #8b2e2e;

  --font-display: Georgia, 'Times New Roman', serif;
  --font-body:    -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  --font-mono:    'SF Mono', 'Menlo', 'Consolas', monospace;

  /* --- Semantic tokens --- */
  --bg: var(--cream);
  --fg: var(--ink);
  --fg-muted: var(--graphite);
  --border: var(--fog);
  --card-bg: #ffffff;
  --accent: var(--ink);
  --accent-hover: var(--ink-soft);
  --badge-bg: var(--paper);
  --badge-fg: var(--ink-muted);
  --radius: 6px;
  --radius-sm: 3px;
}

@media (prefers-color-scheme: dark) {
  :root {
    --bg: var(--ink);
    --fg: var(--cream);
    --fg-muted: var(--slate);
    --border: #3a3a40;
    --card-bg: var(--ink-soft);
    --accent: var(--cream);
    --accent-hover: var(--silver);
    --badge-bg: #3a3a40;
    --badge-fg: var(--silver);
  }
}

* { box-sizing: border-box; margin: 0; padding: 0; }

body {
  font-family: var(--font-body);
  font-size: 13px;
  color: var(--fg);
  background: var(--bg);
  line-height: 1.5;
  -webkit-font-smoothing: antialiased;
  max-width: 700px;
  margin: 0 auto;
}

/* --- Header --- */
#header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 10px 12px;
  border-bottom: 1px solid var(--border);
  position: sticky;
  top: 0;
  background: var(--bg);
  z-index: 10;
}

.header-left {
  display: flex;
  align-items: center;
  gap: 6px;
}

.logo-svg {
  height: 18px;
  width: auto;
  color: var(--fg);
}

.header-subtitle {
  font-size: 11px;
  font-weight: 500;
  color: var(--fg-muted);
  letter-spacing: 0.02em;
}

.header-right {
  display: flex;
  align-items: center;
  gap: 8px;
}

.status-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: var(--fg-muted);
  flex-shrink: 0;
}

.status-dot.connected { background: var(--success); }
.status-dot.error { background: var(--error); }

.status-label {
  font-size: 11px;
  color: var(--fg-muted);
  font-weight: 500;
}

.settings-link {
  color: var(--fg-muted);
  text-decoration: none;
  font-size: 12px;
  font-weight: 500;
  padding: 4px 8px;
  background: none;
  border: none;
  cursor: pointer;
  font-family: var(--font-body);
}

.settings-link:hover { color: var(--fg); text-decoration: underline; }

/* --- Settings panel --- */
.settings-panel {
  border-bottom: 1px solid var(--border);
  padding: 0 12px 12px;
}

.settings-header {
  padding: 8px 0;
  border-bottom: 1px solid var(--border);
  margin-bottom: 8px;
}

.settings-header h3 {
  font-size: 13px;
  font-weight: 600;
}

.settings-body {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.settings-label {
  display: flex;
  flex-direction: column;
  gap: 3px;
  font-size: 11px;
  font-weight: 500;
  color: var(--fg-muted);
}

.settings-input {
  padding: 4px 8px;
  font-family: var(--font-body);
  font-size: 12px;
  color: var(--fg);
  background: var(--card-bg);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
}

.settings-input:focus {
  outline: none;
  border-color: var(--accent);
}

.btn-settings-save {
  align-self: flex-start;
  margin-top: 4px;
}

/* --- Buttons --- */
.btn-primary {
  padding: 6px 14px;
  background: var(--accent);
  color: var(--cream);
  border: none;
  border-radius: var(--radius-sm);
  font-family: var(--font-body);
  font-size: 12px;
  font-weight: 500;
  cursor: pointer;
  white-space: nowrap;
  letter-spacing: 0.01em;
  transition: background 0.15s ease;
}

.btn-primary:hover { background: var(--accent-hover); }
.btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }

@media (prefers-color-scheme: dark) {
  .btn-primary { color: var(--ink); }
}

.btn-sync {
  width: 100%;
  margin-top: 12px;
}

.btn-row {
  display: flex;
  gap: 8px;
  margin-top: 12px;
}

.btn-action {
  flex: 1;
}

.btn-secondary-action {
  background: var(--badge-bg);
  color: var(--fg);
  border: 1px solid var(--border);
}

.btn-secondary-action:hover {
  background: var(--border);
}

/* --- Mode views --- */
.mode-view {
  padding: 12px;
}

/* --- Status card --- */
.status-card {
  border: 1px solid var(--border);
  border-radius: var(--radius);
  background: var(--card-bg);
  overflow: hidden;
}

.status-card-header {
  font-size: 10px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.06em;
  color: var(--fg-muted);
  padding: 8px 12px;
  border-bottom: 1px solid var(--border);
  background: var(--badge-bg);
}

.status-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 6px 12px;
  border-bottom: 1px solid var(--border);
}

.status-row:last-child {
  border-bottom: none;
}

.status-key {
  font-size: 12px;
  color: var(--fg-muted);
  font-weight: 500;
}

.status-value {
  font-family: var(--font-mono);
  font-size: 12px;
  color: var(--fg);
  font-weight: 500;
}

/* --- Progress bar --- */
.progress-section {
  margin-top: 12px;
}

.progress-label {
  font-size: 11px;
  color: var(--fg-muted);
  font-weight: 500;
  margin-bottom: 4px;
  display: flex;
  justify-content: space-between;
}

.progress-bar {
  height: 6px;
  background: var(--badge-bg);
  border-radius: 3px;
  overflow: hidden;
}

.progress-fill {
  height: 100%;
  background: var(--success);
  border-radius: 3px;
  transition: width 0.3s ease;
  width: 0%;
}

/* --- Info card (disconnected state) --- */
.info-card {
  border: 1px solid var(--border);
  border-radius: var(--radius);
  background: var(--card-bg);
  padding: 20px;
  text-align: center;
}

.info-card-icon {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  background: var(--badge-bg);
  color: var(--fg-muted);
  font-weight: 700;
  font-size: 16px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  margin-bottom: 8px;
}

.info-card-title {
  font-size: 14px;
  font-weight: 600;
  margin-bottom: 8px;
}

.info-card-body {
  font-size: 12px;
  color: var(--fg-muted);
  line-height: 1.5;
}

.info-card-body p {
  margin-bottom: 8px;
}

.command-hint {
  display: block;
  font-family: var(--font-mono);
  font-size: 11px;
  background: var(--badge-bg);
  padding: 6px 10px;
  border-radius: var(--radius-sm);
  margin: 8px auto;
  max-width: fit-content;
  color: var(--fg);
}

.info-card-note {
  font-size: 11px;
  color: var(--slate);
  margin-top: 4px;
}

/* --- Error card --- */
.error-card {
  border: 1px solid var(--error);
  border-radius: var(--radius);
  background: var(--oxblood-faint);
  padding: 12px;
  margin-top: 12px;
}

@media (prefers-color-scheme: dark) {
  .error-card {
    background: rgba(139, 46, 46, 0.15);
  }
}

.error-card-title {
  font-size: 12px;
  font-weight: 600;
  color: var(--error);
  margin-bottom: 4px;
}

.error-card-body {
  font-size: 12px;
  color: var(--fg-muted);
  word-break: break-word;
}

/* --- Toast --- */
.toast {
  position: fixed;
  bottom: 16px;
  left: 50%;
  transform: translateX(-50%);
  padding: 8px 16px;
  background: var(--ink);
  color: var(--cream);
  border-radius: var(--radius);
  font-family: var(--font-body);
  font-size: 12px;
  z-index: 100;
  animation: fadeIn 0.2s ease-out;
}

@keyframes fadeIn { from { opacity: 0; transform: translateX(-50%) translateY(8px); } }

/* --- Spinner --- */
.loading {
  text-align: center;
  padding: 32px 16px;
  color: var(--fg-muted);
}

.spinner {
  display: inline-block;
  width: 20px;
  height: 20px;
  border: 2px solid var(--border);
  border-top-color: var(--accent);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
  margin-bottom: 8px;
}

@keyframes spin { to { transform: rotate(360deg); } }

/* --- Setup card --- */
.setup-card {
  border: 1px solid var(--border);
  border-radius: var(--radius);
  background: var(--card-bg);
  overflow: hidden;
}

.setup-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 8px 12px;
  border-bottom: 1px solid var(--border);
}

.setup-row:last-child { border-bottom: none; }

.setup-label {
  font-size: 12px;
  color: var(--fg-muted);
  font-weight: 500;
}

.setup-status {
  font-family: var(--font-mono);
  font-size: 12px;
  display: flex;
  align-items: center;
  gap: 6px;
}

.setup-check { color: var(--success); font-weight: 600; }
.setup-x { color: var(--error); font-weight: 600; }

.setup-actions {
  padding: 8px 12px;
  border-bottom: 1px solid var(--border);
  display: flex;
  gap: 8px;
}

.setup-actions:last-child { border-bottom: none; }

.btn-sm { padding: 4px 10px; font-size: 11px; }

.btn-danger { background: var(--error); }
.btn-danger:hover { background: var(--oxblood-light); }

.setup-progress {
  padding: 8px 12px;
  border-bottom: 1px solid var(--border);
}

.setup-progress-text {
  font-size: 11px;
  color: var(--fg-muted);
  font-family: var(--font-mono);
}

.setup-spinner {
  display: inline-block;
  width: 10px;
  height: 10px;
  border: 1.5px solid var(--border);
  border-top-color: var(--accent);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}
</style>
</head>
<body>
  <header id="header">
    <div class="header-left">
      <svg class="logo-svg" viewBox="0 0 431.65 106.93" xmlns="http://www.w3.org/2000/svg" fill="currentColor" aria-label="inCite">
        <path d="M134.07,43.68c7.47-8.22,17.49-13.22,28.85-10.73,11.03,2.42,14.83,11.61,14.83,21.88,0,13.48-.02,26.67-.02,39.38,0,5.02,2.32,8.07,7.68,8.28v2.63s-35.4.01-35.4.01l-.08-2.62c5.74-.71,7.68-2.98,7.66-8.54-.04-13.41-.25-28.59-.25-42.25-.8-11.86-12.45-12.31-19.92-5.53-1,.91-2.47,2.2-2.64,3.6,0,13.8,0,27.88,0,41.78,0,2.81.34,7.21,2.65,9.11,1.43,1.18,3.22,1.34,4.94,1.78l.1,2.66h-35.52l.03-2.62c5.39-.39,7.42-2.57,7.86-7.86l.04-45.34c0-5.56-2.26-9.56-8.41-9.71v-2.64c9.2.79,17.62-2.36,26.05-5.47.36.07.49,1.18.56,1.54.63,3.37.6,7.22.99,10.65"/>
        <path d="M267.94,12.53l1.73,24.43-3.45.24c-4.02-10.78-9.01-24.78-22.13-26.61-15.79-2.21-24.49,11.71-27.62,25.13-4.63,19.9-3.81,68.94,26.68,66.52,14.64-1.16,19.78-15.65,24.27-27.37l3.07.71-1.9,24.03c-4.62,2.79-9.95,4.78-15.24,5.88-24.12,5.01-48.98-2.78-58.09-27.12-5.27-14.09-5.04-32.79,1.24-46.53C209,4.51,243.08-.72,267.94,12.53"/>
        <path d="M431.19,67.44h-41.28c.01,6.12.99,13.68,4.13,19.03,6.64,11.33,22.48,11.56,31.64,3.17,1.18-1.08,2.03-2.41,3.24-3.44l2.46,1.75c-4.38,9.39-12.29,16.92-22.89,18.33-30.13,4.02-45.32-23.98-37.27-50.47,5.34-17.6,23.06-27.03,40.89-22.44,15.17,3.91,21.37,19.55,19.1,34.06M412.23,62.88c.73-6.24.57-13.59-1.74-19.5-1.85-4.72-5.84-7.67-11.05-5.89-5.45,1.86-7.52,8.96-8.5,14.06-.72,3.73-1.19,7.52-1.04,11.32h22.32Z"/>
        <path d="M348.15,12.72v21.84h15.36v4.8h-15.36v51c0,.57.5,2.48.71,3.13,2.38,7.25,11.32,4.9,15.04.13l2.25,2.26c-1.7,2.98-4,5.65-6.89,7.52-8.59,5.57-23.59,4.5-28.76-5.23-.91-1.72-2.28-5.42-2.28-7.32v-51.12l-.36-.36h-9v-3.84c11.85-2.02,20.23-11.79,23.76-22.8h5.52Z"/>
        <path d="M307.35,93.72c.07.97.36,2.51.6,3.48.99,3.99,3.73,4.99,7.55,5.29v2.63c-2.5-.05-5.04.06-7.56,0-.57-.01-1.09-.25-1.66-.26-9.26-.15-18.51.05-27.73.49l.15-2.89c2.34-.37,5.24-.47,6.8-2.51,1.43-1.86,1.93-5.81,1.93-8.15,0-11.86-.26-26.63-.26-38.88,0-1.43.1-2.87-.02-4.3-.45-5.2-2.91-9.13-8.61-8.79v-3.12c4.26.81,8.1.63,12.24-.6,5.76-1.72,10.92-5.52,16.56-7.56v65.16Z"/>
        <path d="M92.31,28.56v65.64c.37,5.22,2.54,8.44,8.16,8.28v2.64l-37.2.24v-2.88c2.15-.16,5.12-.47,6.73-2.03,1.97-1.9,2.4-6.48,2.4-9.12,0-11.95-.26-26.26-.26-38.4,0-3.35.27-6.32-1.34-9.46-1.41-2.75-4.58-3.99-7.53-3.63v-3.12c4.04.7,7.78.75,11.76-.36,6.15-1.72,11.27-5.77,17.28-7.8"/>
        <path d="M294.82.08c6.84-.57,13.81,2.33,14.42,9.92,1.21,15.04-21.9,15.74-25,4.12-2.1-7.88,2.88-13.39,10.58-14.04"/>
        <path d="M79.78.08c8.52-.71,15.12,3.59,14.21,12.77-1.3,12.96-26.66,12.73-25.19-3.35.53-5.87,5.53-8.96,10.99-9.41"/>
        <path d="M21.92,69.82h16.32c.16,0,.31.08.39.21l21.47,34.49c.17.28-.05.62-.4.62h-16.12c-.17,0-.33-.09-.4-.22l-6.37-11.2-6.32-11.82c-.08-.14-.23-.23-.41-.23s-.33.09-.41.23l-6.32,11.82-6.37,11.2c-.08.14-.23.22-.4.22H.45c-.35,0-.57-.34-.39-.62l21.46-34.49c.08-.13.23-.21.4-.21"/>
      </svg>
      <span class="header-subtitle">Control Center</span>
    </div>
    <div class="header-right">
      <span id="status-dot" class="status-dot" title="Checking connection..."></span>
      <span id="status-label" class="status-label">Checking...</span>
      <button id="btn-settings-toggle" class="settings-link">Settings</button>
    </div>
  </header>

  <div id="settings-panel" class="settings-panel" style="display:none;">
    <div class="settings-header">
      <h3>Settings</h3>
    </div>
    <div class="settings-body">
      <label class="settings-label">
        API Mode
        <select id="setting-apiMode" class="settings-input">
          <option value="local">Local</option>
          <option value="cloud">Cloud</option>
        </select>
      </label>
      <label class="settings-label" id="label-localUrl">
        Local Server URL
        <input type="text" id="setting-localUrl" class="settings-input" placeholder="http://127.0.0.1:8230">
      </label>
      <label class="settings-label" id="label-cloudUrl" style="display:none;">
        Cloud Server URL
        <input type="text" id="setting-cloudUrl" class="settings-input" placeholder="https://inciteref.com">
      </label>
      <label class="settings-label" id="label-apiToken" style="display:none;">
        API Token
        <input type="password" id="setting-apiToken" class="settings-input" placeholder="Your API token">
      </label>
      <button id="btn-settings-save" class="btn-primary btn-settings-save">Save Settings</button>
    </div>
  </div>

  <!-- Local mode view -->
  <div id="local-view" class="mode-view">
    <div id="local-connected" style="display:none;">
      <div class="status-card">
        <div class="status-card-header">Server Status</div>
        <div class="status-row"><span class="status-key">Corpus</span><span id="local-corpus" class="status-value">—</span></div>
        <div class="status-row"><span class="status-key">Embedder</span><span id="local-embedder" class="status-value">—</span></div>
        <div class="status-row"><span class="status-key">Method</span><span id="local-method" class="status-value">—</span></div>
        <div class="status-row"><span class="status-key">Mode</span><span id="local-mode" class="status-value">—</span></div>
      </div>
    </div>
    <div id="local-disconnected">
      <div class="setup-card">
        <div class="status-card-header">Setup</div>
        <div class="setup-row">
          <span class="setup-label">Python</span>
          <span id="setup-python-status" class="setup-status"><span class="setup-spinner"></span> Checking...</span>
        </div>
        <div class="setup-row">
          <span class="setup-label">inCite</span>
          <span id="setup-incite-status" class="setup-status"><span class="setup-spinner"></span> Checking...</span>
        </div>
        <div id="setup-install-row" class="setup-actions" style="display:none;">
          <button id="btn-install-incite" class="btn-primary btn-sm">Install inCite</button>
        </div>
        <div id="setup-install-progress" class="setup-progress" style="display:none;">
          <span id="install-progress-text" class="setup-progress-text">Installing...</span>
        </div>
        <div class="setup-row">
          <span class="setup-label">Server</span>
          <span id="setup-server-status" class="setup-status">Stopped</span>
        </div>
        <div id="setup-server-actions" class="setup-actions">
          <button id="btn-start-server" class="btn-primary btn-sm" disabled>Start Server</button>
          <button id="btn-stop-server" class="btn-primary btn-sm btn-danger" style="display:none;">Stop Server</button>
        </div>
        <div class="setup-row">
          <span class="setup-label">Library</span>
          <span id="setup-process-status" class="setup-status">Not processed</span>
        </div>
        <div id="setup-process-actions" class="setup-actions">
          <button id="btn-process-library" class="btn-primary btn-sm" disabled>Process Library</button>
        </div>
        <div id="setup-process-progress" class="setup-progress" style="display:none;">
          <div class="progress-label">
            <span id="process-stage-text" class="setup-progress-text">Processing...</span>
            <span id="process-progress-pct" style="font-size:11px; color:var(--fg-muted); font-family:var(--font-mono);">0%</span>
          </div>
          <div class="progress-bar" style="margin: 6px 0;">
            <div id="process-progress-fill" class="progress-fill"></div>
          </div>
          <div id="process-detail-text" style="font-size:11px; color:var(--slate); margin-top:2px;"></div>
        </div>
      </div>
      <div id="setup-python-missing" class="info-card" style="display:none; margin-top:12px;">
        <div class="info-card-body">
          <p>Python 3 is required. Download it from <a href="#" onclick="window.open('https://www.python.org/downloads/'); return false;">python.org</a>.</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Cloud mode view -->
  <div id="cloud-view" class="mode-view" style="display:none;">
    <div id="cloud-connected" style="display:none;">
      <div class="status-card">
        <div class="status-card-header">Library Status</div>
        <div class="status-row"><span class="status-key">Status</span><span id="cloud-status" class="status-value">—</span></div>
        <div class="status-row"><span class="status-key">Papers</span><span id="cloud-papers" class="status-value">—</span></div>
        <div class="status-row"><span class="status-key">Chunks</span><span id="cloud-chunks" class="status-value">—</span></div>
        <div class="status-row"><span class="status-key">Full-text papers</span><span id="cloud-fulltext-papers" class="status-value">—</span></div>
        <div class="status-row"><span class="status-key">Full-text chunks</span><span id="cloud-fulltext-chunks" class="status-value">—</span></div>
        <div class="status-row"><span class="status-key">Abstract-only</span><span id="cloud-abstract-only" class="status-value">—</span></div>
      </div>
      <div id="cloud-progress" class="progress-section" style="display:none;">
        <div class="progress-label"><span id="progress-stage">Processing</span> <span id="progress-count"></span></div>
        <div class="progress-bar"><div id="progress-fill" class="progress-fill"></div></div>
      </div>
      <div class="btn-row">
        <button id="btn-upload" class="btn-primary btn-action">Upload Library</button>
        <button id="btn-sync" class="btn-primary btn-action btn-secondary-action">Sync Library</button>
      </div>
      <div id="upload-progress" class="progress-section" style="display:none;">
        <div class="progress-label"><span id="upload-stage">Uploading</span> <span id="upload-count"></span></div>
        <div class="progress-bar"><div id="upload-fill" class="progress-fill"></div></div>
      </div>
      <div id="sync-progress" class="progress-section" style="display:none;">
        <div class="progress-label"><span id="sync-stage">Syncing</span> <span id="sync-count"></span></div>
      </div>
    </div>
    <div id="cloud-disconnected" class="info-card">
      <div class="info-card-icon">!</div>
      <div class="info-card-title">Not Connected</div>
      <div class="info-card-body">
        <p>Enter your API token in Settings to connect to inCite Cloud.</p>
      </div>
    </div>
    <div id="cloud-error" class="error-card" style="display:none;">
      <div class="error-card-title">Error</div>
      <div id="cloud-error-message" class="error-card-body"></div>
    </div>
  </div>

  <script>(()=>{var b=class{async get(t,e){let s=await fetch(t,{method:"GET",headers:{Accept:"application/json",...e}});if(!s.ok)throw new Error(`HTTP ${s.status}: ${s.statusText}`);return s.json()}async post(t,e,s){let r=await fetch(t,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json",...s},body:JSON.stringify(e)});if(!r.ok)throw new Error(`HTTP ${r.status}: ${r.statusText}`);return r.json()}},v=class{constructor(t,e){typeof t=="string"?this.config={apiMode:"local",cloudUrl:"https://inciteref.com",localUrl:t,apiToken:""}:this.config={...t},this.transport=e??new b}updateConfig(t){Object.assign(this.config,t)}setBaseUrl(t){this.config.localUrl=t}getBaseUrl(){return this.config.apiMode==="cloud"?this.config.cloudUrl:this.config.localUrl}getAuthHeaders(){return this.config.apiMode==="cloud"&&this.config.apiToken?{Authorization:`Bearer ${this.config.apiToken}`}:{}}getEndpoint(t){if(this.config.apiMode==="cloud")switch(t){case"/health":return"/api/v1/health";case"/recommend":return"/api/v1/recommend";default:return t}return t}async authGet(t){let e=`${this.getBaseUrl()}${this.getEndpoint(t)}`;return this.transport.get(e,this.getAuthHeaders())}async authPost(t,e){let s=`${this.getBaseUrl()}${this.getEndpoint(t)}`;return this.transport.post(s,e,this.getAuthHeaders())}async health(){let e=await this.authGet("/health");return this.config.apiMode==="cloud"&&e.ready===void 0?{...e,ready:e.status==="ready"}:e}async recommend(t,e,s,r,i){let a={query:t,k:e,author_boost:s};return r!==void 0&&(a.cursor_sentence_index=r),i&&(a.collection_id=i),await this.authPost("/recommend",a)}async savePapers(t){return await this.authPost("/api/v1/library/papers",t)}async checkLibrary(t){return(await this.authPost("/api/v1/library/check",{papers:t})).results}async getCollections(){return(await this.authGet("/api/v1/library/collections")).collections}async searchTags(t){let e=encodeURIComponent(t);return(await this.authGet(`/api/v1/library/tags/search?q=${e}`)).tags}async serverConfig(){let t=`${this.config.localUrl}/config`;return this.transport.get(t)}async libraryStatus(){return this.authGet("/api/v1/upload-library/status")}async libraryRefresh(){return this.authPost("/api/library/refresh",{})}};var c="http://localhost:23119",P={apiMode:"local",localUrl:"http://127.0.0.1:8230",cloudUrl:"https://inciteref.com",apiToken:""},l={...P},C=null,x=0;async function O(){try{let n=await fetch(c+"/incite/settings");if(n.ok){let t=await n.json();l={...P,...t}}}catch{}}async function F(){try{let n=await fetch(c+"/incite/settings",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(l)});n.ok?d("Settings saved"):d("Failed to save settings (HTTP "+n.status+")")}catch{d("Failed to save settings")}}function N(){let n={apiMode:l.apiMode,localUrl:l.localUrl,cloudUrl:l.cloudUrl,apiToken:l.apiToken};return new v(n,new b)}var M=document.getElementById("status-dot"),D=document.getElementById("status-label"),$=document.getElementById("settings-panel"),q=document.getElementById("btn-settings-toggle"),G=document.getElementById("btn-settings-save"),J=document.getElementById("local-view"),w=document.getElementById("local-connected"),_=document.getElementById("local-disconnected"),z=document.getElementById("cloud-view"),k=document.getElementById("cloud-connected"),I=document.getElementById("cloud-disconnected"),T=document.getElementById("cloud-error"),R=document.getElementById("cloud-error-message"),g=document.getElementById("btn-sync"),m=document.getElementById("btn-upload"),S=document.getElementById("btn-install-incite"),u=document.getElementById("btn-start-server"),f=document.getElementById("btn-stop-server"),p=document.getElementById("btn-process-library");q.addEventListener("click",()=>{let n=$.style.display!=="none";$.style.display=n?"none":"block",n||A()});G.addEventListener("click",async()=>{nt(),await F(),$.style.display="none",U(),h()});document.getElementById("setting-apiMode")?.addEventListener("change",()=>{j()});S?.addEventListener("click",()=>K());u?.addEventListener("click",()=>X());f?.addEventListener("click",()=>W());p?.addEventListener("click",()=>V());m?.addEventListener("click",()=>Z());g.addEventListener("click",()=>Y());async function H(){let n=document.getElementById("setup-python-status"),t=document.getElementById("setup-incite-status"),e=document.getElementById("setup-install-row"),s=document.getElementById("setup-python-missing");n.innerHTML='<span class="setup-spinner"></span> Checking...';try{let i=await(await fetch(c+"/incite/system/python")).json();if(i.found){n.innerHTML=`<span class="setup-check">\u2713</span> ${i.version}`,s.style.display="none",t.innerHTML='<span class="setup-spinner"></span> Checking...';let o=await(await fetch(c+"/incite/system/incite")).json();o.installed?(t.innerHTML=`<span class="setup-check">\u2713</span> ${o.version}`,e.style.display="none",u.disabled=!1,p.disabled=!1):(t.innerHTML='<span class="setup-x">\u2717</span> Not installed',e.style.display="flex",u.disabled=!0,p.disabled=!0)}else n.innerHTML='<span class="setup-x">\u2717</span> Not found',t.innerHTML='<span class="setup-x">\u2717</span> \u2014',s.style.display="block",e.style.display="none",u.disabled=!0,p.disabled=!0}catch{n.innerHTML='<span class="setup-x">\u2717</span> Error',t.innerHTML='<span class="setup-x">\u2717</span> \u2014'}}async function K(){let n=document.getElementById("setup-install-row"),t=document.getElementById("setup-install-progress"),e=document.getElementById("install-progress-text");S.disabled=!0,n.style.display="none",t.style.display="block",e.textContent="Setting up local server...";try{await fetch(c+"/incite/system/install",{method:"POST"});let s=0,r=async()=>{s++;try{let a=await(await fetch(c+"/incite/system/install/status")).json();if(a.status==="running"||a.status==="idle")e.textContent=a.status==="idle"?"Starting install...":"Installing... (this may take a few minutes)",setTimeout(r,3e3);else if(a.status==="done")t.style.display="none",d("inCite installed successfully"),H();else if(a.status==="error"){let o=a.output??"";e.textContent="Install failed: "+(o.length>500?"..."+o.slice(-500):o),S.disabled=!1,n.style.display="flex"}}catch{s<60?setTimeout(r,3e3):(e.textContent="Install status unknown \u2014 check Zotero console",S.disabled=!1,n.style.display="flex")}};setTimeout(r,3e3)}catch{e.textContent="Install failed",S.disabled=!1,n.style.display="flex"}}async function X(){u.disabled=!0,u.textContent="Starting...";let n=document.getElementById("setup-server-status");n.textContent="Starting...";try{await fetch(c+"/incite/system/server/start",{method:"POST"}),d("Server starting..."),setTimeout(()=>h(5e3),3e3)}catch{d("Failed to start server"),u.disabled=!1,u.textContent="Start Server",n.textContent="Stopped"}}async function W(){f.disabled=!0;try{await fetch(c+"/incite/system/server/stop",{method:"POST"}),d("Server stopped"),h()}catch{d("Failed to stop server")}f.disabled=!1}function E(n){let t=document.getElementById("setup-process-progress"),e=document.getElementById("process-stage-text"),s=document.getElementById("process-progress-pct"),r=document.getElementById("process-progress-fill"),i=document.getElementById("process-detail-text");if(t.style.display="block",n.status==="error"){e.textContent=n.stage||"Error",e.style.color="var(--red, #e55)",s.textContent="",r.style.width="0%",r.style.background="var(--red, #e55)",i.textContent=n.detail||n.output||"",i.style.color="var(--red, #e55)";return}e.style.color="",r.style.background="",i.style.color="",e.textContent=n.stage||n.output||"Processing...";let a=n.progress??0;s.textContent=`${a}%`,r.style.width=`${a}%`,i.textContent=n.detail||""}async function V(){let n=document.getElementById("setup-process-progress"),t=document.getElementById("setup-process-status");p.disabled=!0,E({status:"running",output:"Starting library processing...",stage:"Starting...",progress:0}),t.textContent="Processing...";try{await fetch(c+"/incite/system/process",{method:"POST"});let e=0,s=async()=>{e++;try{let i=await(await fetch(c+"/incite/system/process/status")).json();if(i.status==="running"||i.status==="idle")E(i),setTimeout(s,3e3);else if(i.status==="done")E({status:"done",output:"Server ready",stage:"Server ready",progress:100}),setTimeout(()=>{n.style.display="none",t.textContent="Ready"},1e3),d("Library processed successfully"),h(5e3);else if(i.status==="error"){let a=i.output??"",o=document.getElementById("process-stage-text");o.textContent="Failed: "+(a.length>300?"..."+a.slice(-300):a);let B=document.getElementById("process-progress-pct");B.textContent="",t.textContent="Error",p.disabled=!1}}catch{if(e<60)setTimeout(s,3e3);else{let r=document.getElementById("process-stage-text");r.textContent="Status unknown \u2014 check Zotero console",p.disabled=!1}}};setTimeout(s,3e3)}catch{let e=document.getElementById("process-stage-text");e.textContent="Failed to start processing",t.textContent="Error",p.disabled=!1}}async function Z(){let n=document.getElementById("upload-progress"),t=document.getElementById("upload-stage"),e=document.getElementById("upload-count"),s=document.getElementById("upload-fill");m.disabled=!0,m.textContent="Uploading...",n.style.display="block",t.textContent="Starting upload...",e.textContent="",s.style.width="0%";try{await fetch(c+"/incite/cloud/upload",{method:"POST"});let r=0,i=async()=>{r++;try{let o=await(await fetch(c+"/incite/cloud/upload/status")).json();if(o.status==="done"){n.style.display="none",d("Library uploaded successfully"),m.disabled=!1,m.textContent="Upload Library",h(1e4);return}if(o.status==="error"){t.textContent="Upload failed",e.textContent="",s.style.width="0%",d("Upload failed: "+o.message),m.disabled=!1,m.textContent="Upload Library";return}if(t.textContent=o.message||L(o.status),o.current!=null&&o.total!=null&&o.total>0){let B=Math.round(o.current/o.total*100);e.textContent=`${o.current}/${o.total}`,s.style.width=`${B}%`}else e.textContent="",s.style.width="0%";setTimeout(i,2e3)}catch{r<120?setTimeout(i,3e3):(t.textContent="Upload status unknown",m.disabled=!1,m.textContent="Upload Library")}};setTimeout(i,2e3)}catch{d("Failed to start upload"),m.disabled=!1,m.textContent="Upload Library",n.style.display="none"}}async function Y(){let n=document.getElementById("sync-progress"),t=document.getElementById("sync-stage"),e=document.getElementById("sync-count");g.disabled=!0,g.textContent="Syncing...",n.style.display="block",t.textContent="Starting sync...",e.textContent="";try{let s=await fetch(c+"/incite/cloud/sync",{method:"POST"});if(!s.ok)throw new Error(`HTTP ${s.status}: ${await s.text()}`);let r=0,i=async()=>{r++;try{let o=await(await fetch(c+"/incite/cloud/sync/status")).json();if(o.status==="done"){n.style.display="none",d(o.message||"Sync complete"),g.disabled=!1,g.textContent="Sync Library",h(1e4);return}if(o.status==="error"){t.textContent="Sync failed",e.textContent="",d("Sync failed: "+o.message),g.disabled=!1,g.textContent="Sync Library";return}t.textContent=o.message||L(o.status),(o.created!=null||o.skipped!=null)&&(e.textContent=`${o.created??0} new, ${o.skipped??0} existing`),setTimeout(i,2e3)}catch{r<120?setTimeout(i,3e3):(t.textContent="Sync status unknown",g.disabled=!1,g.textContent="Sync Library")}};setTimeout(i,2e3)}catch(s){d("Failed to start sync: "+(s instanceof Error?s.message:String(s))),g.disabled=!1,g.textContent="Sync Library",n.style.display="none"}}O().then(()=>{A(),U(),h(),l.apiMode==="local"&&H()});function U(){let n=l.apiMode==="cloud";J.style.display=n?"none":"block",z.style.display=n?"block":"none"}function h(n){C&&(clearTimeout(C),C=null);let t=++x,e=()=>{t===x&&(l.apiMode==="cloud"?tt(t).then(s=>{t===x&&(C=setTimeout(e,s??n??6e4))}):Q().then(()=>{t===x&&(C=setTimeout(e,n??3e4))}))};e()}async function Q(){try{let n=N(),t=await n.health(),e=document.getElementById("setup-server-status");if(e&&(e.textContent="Running"),u&&(u.style.display="none"),f&&(f.style.display="inline-block"),!t.ready){w.style.display="none",_.style.display="block";let i=document.getElementById("setup-process-status");try{let o=await(await fetch(c+"/incite/system/process/status")).json();o.status==="error"?(y("error","Server error"),i&&(i.textContent="Error"),E(o),p.disabled=!1):(y("connected","Loading..."),i&&(i.textContent="Loading..."),p.disabled=!0,(o.stage||o.progress)&&E(o))}catch{y("connected","Loading..."),i&&(i.textContent="Loading..."),p.disabled=!0}return}y("connected",`Connected \u2014 ${t.corpus_size??"?"} papers`),w.style.display="block",_.style.display="none";let s=document.getElementById("setup-process-status");s&&(s.textContent=`Ready (${t.corpus_size??0} papers)`);let r=document.getElementById("setup-process-progress");r&&(r.style.display="none"),p.disabled=!1,document.getElementById("local-corpus").textContent=String(t.corpus_size??"\u2014");try{let i=await n.serverConfig();document.getElementById("local-embedder").textContent=i.embedder,document.getElementById("local-method").textContent=i.method,document.getElementById("local-mode").textContent=i.mode}catch{document.getElementById("local-embedder").textContent="\u2014",document.getElementById("local-method").textContent="\u2014",document.getElementById("local-mode").textContent="\u2014"}}catch{y("error","Not connected"),w.style.display="none",_.style.display="block";let n=document.getElementById("setup-server-status");n&&(n.textContent="Stopped"),u&&(u.style.display="inline-block",u.textContent="Start Server"),f&&(f.style.display="none")}}async function tt(n){try{let t=await fetch(c+"/incite/cloud/status");if(!t.ok)throw new Error(`HTTP ${t.status}: ${await t.text()}`);if(n!=null&&n!==x)return 6e4;let e=await t.json();if(e.library_status==="no_token")return y("error","Not connected"),k.style.display="none",I.style.display="block",T.style.display="none",6e4;y("connected",et(e.library_status)),k.style.display="block",I.style.display="none",T.style.display="none",document.getElementById("cloud-status").textContent=e.library_status,document.getElementById("cloud-papers").textContent=String(e.num_papers),document.getElementById("cloud-chunks").textContent=String(e.num_chunks),document.getElementById("cloud-fulltext-papers").textContent=String(e.grobid_fulltext_papers),document.getElementById("cloud-fulltext-chunks").textContent=String(e.grobid_fulltext_chunks),document.getElementById("cloud-abstract-only").textContent=String(e.abstract_only_papers);let s=document.getElementById("cloud-progress"),r=new Set(["idle","completed","failed"]);if(e.job_status&&!r.has(e.job_status)){if(s.style.display="block",document.getElementById("progress-stage").textContent=L(e.stage??"Processing"),e.current!=null&&e.total!=null&&e.total>0){let i=Math.round(e.current/e.total*100);document.getElementById("progress-count").textContent=`${e.current}/${e.total}`,document.getElementById("progress-fill").style.width=`${i}%`}else document.getElementById("progress-count").textContent="",document.getElementById("progress-fill").style.width="0%";return 1e4}else s.style.display="none";return e.error&&(T.style.display="block",R.textContent=e.error),6e4}catch(t){if(n!=null&&n!==x)return 6e4;let e=t instanceof Error?t.message:String(t);return console.error("inCite cloud status error:",e),l.apiToken?(y("error","Connection error"),k.style.display="none",I.style.display="none",T.style.display="block",R.textContent=e):(y("error","Not connected"),k.style.display="none",I.style.display="block",T.style.display="none"),6e4}}function y(n,t){M.className=`status-dot ${n}`,M.title=t,D.textContent=t}function et(n){switch(n){case"ready":return"Library ready";case"processing":return"Processing...";case"no_library":return"No library";default:return n}}function L(n){return n.charAt(0).toUpperCase()+n.slice(1)}function A(){document.getElementById("setting-apiMode").value=l.apiMode,document.getElementById("setting-localUrl").value=l.localUrl,document.getElementById("setting-cloudUrl").value=l.cloudUrl,document.getElementById("setting-apiToken").value=l.apiToken,j()}function nt(){l.apiMode=document.getElementById("setting-apiMode").value,l.localUrl=document.getElementById("setting-localUrl").value,l.cloudUrl=document.getElementById("setting-cloudUrl").value,l.apiToken=document.getElementById("setting-apiToken").value}function j(){let t=document.getElementById("setting-apiMode").value==="cloud";document.getElementById("label-localUrl").style.display=t?"none":"flex",document.getElementById("label-cloudUrl").style.display=t?"flex":"none",document.getElementById("label-apiToken").style.display=t?"flex":"none"}function d(n){let t=document.querySelector(".toast");t&&t.remove();let e=document.createElement("div");e.className="toast",e.textContent=n,document.body.appendChild(e),setTimeout(()=>e.remove(),2500)}})();
</script>
</body>
</html>
